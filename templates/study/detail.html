{% extends "base.html" %}
{% block title %}{{ study_set.title }} - QuizWeaver{% endblock %}

{% block content %}
<div id="study-detail-page" data-study-set-id="{{ study_set.id }}"></div>
<h1>{{ study_set.title }} <span class="help-tip" data-tip="{{ ai_tips.study_review }}">?</span></h1>

<div class="ai-notice" data-dismiss-key="study-detail">
    <button class="ai-notice-dismiss" aria-label="Dismiss notice" title="Dismiss">&times;</button>
    <strong>AI-Generated Content:</strong> This study material was generated by AI. Please review all content for accuracy before sharing with students.
    <br><small>Learn more: <a href="/help#understanding-ai">Understanding AI in QuizWeaver</a></small>
</div>

<div class="quiz-info">
    <p><strong>Type:</strong> <span class="study-type-badge study-type-{{ study_set.material_type }}">{{ study_set.material_type.replace('_', ' ').title() }}</span></p>
    <p><strong>Class:</strong> {{ class_obj.name if class_obj else 'N/A' }}</p>
    <p><strong>Cards:</strong> <span id="card-count">{{ cards|length }}</span></p>
    <p><strong>Status:</strong> <span class="status status-{{ study_set.status }}">{{ study_set.status }}</span></p>
    {% if study_set.created_at %}
    <p><strong>Created:</strong> {{ study_set.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
    {% endif %}
</div>

<div class="export-actions">
    <span class="export-label">Export:</span>
    <a href="/study/{{ study_set.id }}/export/tsv" class="btn btn-sm btn-outline">TSV (Anki)</a>
    <a href="/study/{{ study_set.id }}/export/csv" class="btn btn-sm btn-outline">CSV</a>
    <a href="/study/{{ study_set.id }}/export/pdf" class="btn btn-sm btn-outline">PDF</a>
    <a href="/study/{{ study_set.id }}/export/docx" class="btn btn-sm btn-outline">Word</a>
</div>

{# Reusable card action buttons macro #}
{% macro card_actions(card, loop) %}
<div class="card-actions">
    <button class="btn btn-xs btn-outline card-edit-btn" title="Edit">Edit</button>
    <button class="btn btn-xs btn-outline card-delete-btn" title="Delete">Delete</button>
    <button class="btn btn-xs btn-outline card-move-up" title="Move up" {% if loop.first %}disabled{% endif %}>Up</button>
    <button class="btn btn-xs btn-outline card-move-down" title="Move down" {% if loop.last %}disabled{% endif %}>Down</button>
</div>
{% endmacro %}

{# Reusable edit form macro #}
{% macro edit_form(card) %}
<div class="card-edit-mode" style="display: none;">
    <div class="form-group">
        <label>Front / Term / Heading</label>
        <textarea class="edit-front" rows="2">{{ card.front }}</textarea>
    </div>
    <div class="form-group">
        <label>Back / Definition / Content</label>
        <textarea class="edit-back" rows="3">{{ card.back }}</textarea>
    </div>
    <div class="edit-actions">
        <button class="btn btn-sm btn-primary edit-save-btn">Save</button>
        <button class="btn btn-sm btn-secondary edit-cancel-btn">Cancel</button>
        <small class="text-muted">Ctrl+Enter to save, Esc to cancel</small>
    </div>
</div>
{% endmacro %}

{% if study_set.material_type == 'flashcard' %}
<!-- Flashcard Grid -->
<div class="flashcard-grid card-container">
    {% for card in cards %}
    <div class="flip-card" data-card-id="{{ card.id }}">
        <div class="card-view-mode">
            <div class="flip-card-inner" onclick="if(!this.closest('.editing'))this.parentElement.parentElement.classList.toggle('flipped')">
                <div class="flip-card-front">
                    <span class="flip-card-number card-number">{{ loop.index }}</span>
                    <p class="card-front-text">{{ card.front }}</p>
                    <span class="flip-hint">Click to flip</span>
                </div>
                <div class="flip-card-back">
                    <p class="card-back-text">{{ card.back }}</p>
                    {% if card.data.tags %}
                    <div class="flip-card-tags">
                        {% for tag in card.data.tags %}
                        <span class="tag">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {{ card_actions(card, loop) }}
        </div>
        {{ edit_form(card) }}
    </div>
    {% endfor %}
</div>

{% elif study_set.material_type == 'study_guide' %}
<!-- Study Guide Sections -->
<div class="card-container">
{% for card in cards %}
<div class="study-section" data-card-id="{{ card.id }}">
    <div class="card-view-mode">
        <div class="study-section-header">
            <span class="card-number">{{ loop.index }}</span>
            <h2 class="card-front-text">{{ card.front }}</h2>
        </div>
        <p class="card-back-text">{{ card.back }}</p>
        {% if card.data.key_points %}
        <div class="key-points">
            <strong>Key Points:</strong>
            <ul>
                {% for point in card.data.key_points %}
                <li>{{ point }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {{ card_actions(card, loop) }}
    </div>
    {{ edit_form(card) }}
</div>
{% endfor %}
</div>

{% elif study_set.material_type == 'vocabulary' %}
<!-- Vocabulary Table -->
<div class="card-container">
<table class="data-table" id="vocab-table">
    <thead>
        <tr>
            <th>#</th>
            <th>Term</th>
            <th>Definition</th>
            <th>Example</th>
            <th>Part of Speech</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for card in cards %}
        <tr data-card-id="{{ card.id }}">
            <td class="card-number">{{ loop.index }}</td>
            <td>
                <div class="card-view-mode">
                    <strong class="card-front-text">{{ card.front }}</strong>
                </div>
            </td>
            <td>
                <div class="card-view-mode">
                    <span class="card-back-text">{{ card.back }}</span>
                </div>
            </td>
            <td><em>{{ card.data.get('example', '') }}</em></td>
            <td>{{ card.data.get('part_of_speech', '') }}</td>
            <td>
                <div class="card-actions card-actions-inline">
                    <button class="btn btn-xs btn-outline card-edit-btn" title="Edit">Edit</button>
                    <button class="btn btn-xs btn-outline card-delete-btn" title="Delete">Del</button>
                    <button class="btn btn-xs btn-outline card-move-up" title="Move up" {% if loop.first %}disabled{% endif %}>Up</button>
                    <button class="btn btn-xs btn-outline card-move-down" title="Move down" {% if loop.last %}disabled{% endif %}>Down</button>
                </div>
            </td>
        </tr>
        {# Vocab inline edit row (hidden by default) #}
        <tr class="card-edit-mode vocab-edit-row" data-card-id="{{ card.id }}" style="display: none;">
            <td colspan="6">
                <div class="form-group form-group-inline">
                    <label>Term</label>
                    <textarea class="edit-front" rows="1">{{ card.front }}</textarea>
                </div>
                <div class="form-group form-group-inline">
                    <label>Definition</label>
                    <textarea class="edit-back" rows="2">{{ card.back }}</textarea>
                </div>
                <div class="edit-actions">
                    <button class="btn btn-sm btn-primary edit-save-btn">Save</button>
                    <button class="btn btn-sm btn-secondary edit-cancel-btn">Cancel</button>
                    <small class="text-muted">Ctrl+Enter to save, Esc to cancel</small>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

{% elif study_set.material_type == 'review_sheet' %}
<!-- Review Sheet -->
<div class="card-container">
{% for card in cards %}
<div class="review-item review-type-{{ card.data.get('type', 'fact') }}" data-card-id="{{ card.id }}">
    <div class="card-view-mode">
        <div class="review-item-header">
            <span class="card-number" style="margin-right: 0.5rem;">{{ loop.index }}.</span>
            <h3 class="card-front-text">{{ card.front }}</h3>
            {% if card.data.get('type') %}
            <span class="review-type-tag">{{ card.data.type.upper() }}</span>
            {% endif %}
        </div>
        <p class="card-back-text">{{ card.back }}</p>
        {{ card_actions(card, loop) }}
    </div>
    {{ edit_form(card) }}
</div>
{% endfor %}
</div>

{% else %}
<!-- Generic cards -->
<div class="card-container">
{% for card in cards %}
<div class="question-card" data-card-id="{{ card.id }}">
    <div class="card-view-mode">
        <div class="question-header">
            <span class="question-number card-number">{{ loop.index }}</span>
        </div>
        <p><strong class="card-front-text">{{ card.front }}</strong></p>
        <p class="card-back-text">{{ card.back }}</p>
        {{ card_actions(card, loop) }}
    </div>
    {{ edit_form(card) }}
</div>
{% endfor %}
</div>
{% endif %}

<div class="section-actions">
    <a href="/study" class="btn btn-secondary">Back to Study Materials</a>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/study.js"></script>
<script src="/static/js/study_edit.js"></script>
{% endblock %}
