{% extends "base.html" %}
{% block title %}Settings - QuizWeaver{% endblock %}

{% block content %}
<h1>Settings</h1>

<form method="POST" action="/settings" class="form settings-form">
    <h2>LLM Provider <span class="help-tip" data-tip="{{ ai_tips.provider_selection }}">?</span></h2>
    <p class="text-muted">Choose which language model generates your quizzes. Use Mock for free development, or connect a real provider.
        <a href="/settings/wizard">Use the setup wizard</a> for step-by-step guidance.</p>

    <div class="form-group">
        <label id="provider-label">Provider</label>
        <div class="provider-cards" role="radiogroup" aria-labelledby="provider-label">
            {% for p in providers %}
            <label class="provider-card {% if p.key == current_provider %}selected{% endif %} {% if not p.available %}unavailable{% endif %}">
                <input type="radio" name="provider" value="{{ p.key }}"
                       {% if p.key == current_provider %}checked{% endif %}
                       onchange="toggleProviderFields()">
                <div class="provider-card-body">
                    <strong>{{ p.label }}</strong>
                    {% if p.available %}
                    <span class="badge badge-available">Ready</span>
                    {% else %}
                    <span class="badge badge-unavailable">Setup needed</span>
                    {% endif %}
                    <p>{{ p.description }}</p>
                    {% if not p.available and p.reason %}
                    <p class="provider-reason">{{ p.reason }}</p>
                    {% endif %}
                </div>
            </label>
            {% endfor %}
        </div>
    </div>

    <div class="provider-fields" id="fields-vertex" style="display:none">
        <div class="form-group">
            <label for="vertex_project_id">Google Cloud Project ID</label>
            <input type="text" id="vertex_project_id" name="vertex_project_id"
                   value="{{ llm_config.get('vertex_project_id', '') }}"
                   placeholder="e.g., quizweaver-8402"
                   autocomplete="off">
            <small class="text-muted">Your Google Cloud project ID (find it at <a href="https://console.cloud.google.com" target="_blank" rel="noopener">console.cloud.google.com</a>)</small>
        </div>
        <div class="form-group">
            <label for="vertex_location">Region</label>
            <input type="text" id="vertex_location" name="vertex_location"
                   value="{{ llm_config.get('vertex_location', 'us-central1') }}"
                   placeholder="e.g., us-central1"
                   autocomplete="off">
            <small class="text-muted">Google Cloud region for Vertex AI (us-central1 is recommended)</small>
        </div>
    </div>

    <div class="provider-fields" id="fields-model" style="display:none">
        <div class="form-group">
            <label for="model_name">Model Name</label>
            <input type="text" id="model_name" name="model_name"
                   value="{{ llm_config.get('model_name', '') }}"
                   placeholder="e.g., gpt-4o, gemini-2.5-flash, llama3"
                   autocomplete="off">
            <small class="text-muted">The model identifier your provider uses (e.g., gemini-2.5-flash, gpt-4o, llama3)</small>
        </div>
    </div>

    <div class="provider-fields" id="fields-apikey" style="display:none">
        <div class="form-group">
            <label for="api_key">API Key <span class="help-tip" data-tip="{{ ai_tips.api_key_privacy }}">?</span></label>
            <input type="password" id="api_key" name="api_key"
                   value=""
                   placeholder="{% if llm_config.get('api_key') %}(key set - leave blank to keep){% else %}Enter API key{% endif %}"
                   autocomplete="new-password">
            {% if llm_config.get('api_key') %}
            <small class="text-muted">API key is configured. Leave blank to keep current key.</small>
            {% else %}
            <small class="text-muted">Your API key is stored locally and never shared</small>
            {% endif %}
        </div>
    </div>

    <div class="provider-fields" id="fields-baseurl" style="display:none">
        <div class="form-group">
            <label for="base_url">Base URL</label>
            <input type="url" id="base_url" name="base_url"
                   value="{{ llm_config.get('base_url', '') }}"
                   placeholder="e.g., http://localhost:11434/v1"
                   autocomplete="off">
            <small class="text-muted">The API endpoint for your local or custom model server</small>
        </div>
    </div>

    <div class="test-connection-section">
        <button type="button" class="btn btn-secondary" id="testConnectionBtn" onclick="testProviderConnection()">Test Connection</button>
        <span id="testResult" class="test-result"></span>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Settings</button>
    </div>
</form>

<script>
function toggleProviderFields() {
    var selected = document.querySelector('input[name="provider"]:checked');
    if (!selected) return;
    var val = selected.value;

    // Hide all conditional fields
    document.getElementById('fields-vertex').style.display = 'none';
    document.getElementById('fields-model').style.display = 'none';
    document.getElementById('fields-apikey').style.display = 'none';
    document.getElementById('fields-baseurl').style.display = 'none';

    // Show fields based on provider
    if (val === 'mock') {
        // No extra fields needed
    } else if (val === 'gemini' || val === 'gemini-pro') {
        document.getElementById('fields-model').style.display = 'block';
        document.getElementById('fields-apikey').style.display = 'block';
    } else if (val === 'vertex') {
        document.getElementById('fields-vertex').style.display = 'block';
        document.getElementById('fields-model').style.display = 'block';
    } else if (val === 'openai') {
        document.getElementById('fields-model').style.display = 'block';
        document.getElementById('fields-apikey').style.display = 'block';
    } else if (val === 'openai-compatible') {
        document.getElementById('fields-model').style.display = 'block';
        document.getElementById('fields-apikey').style.display = 'block';
        document.getElementById('fields-baseurl').style.display = 'block';
    }

    // Update card selection visual
    document.querySelectorAll('.provider-card').forEach(function(card) {
        card.classList.remove('selected');
    });
    selected.closest('.provider-card').classList.add('selected');
}

function testProviderConnection() {
    var btn = document.getElementById('testConnectionBtn');
    var result = document.getElementById('testResult');
    var selected = document.querySelector('input[name="provider"]:checked');
    if (!selected) return;

    result.textContent = '';
    result.className = 'test-result';
    if (window.QWLoading) {
        window.QWLoading.setBtnLoading(btn, 'Testing...');
    } else {
        btn.disabled = true;
        btn.textContent = 'Testing...';
    }

    var payload = {
        provider: selected.value,
        model_name: document.getElementById('model_name').value,
        api_key: document.getElementById('api_key').value,
        base_url: document.getElementById('base_url').value,
        vertex_project_id: document.getElementById('vertex_project_id').value,
        vertex_location: document.getElementById('vertex_location').value
    };

    fetch('/api/settings/test-provider', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            result.textContent = '[OK] ' + data.message;
            result.className = 'test-result test-success';
        } else {
            result.textContent = '[FAIL] ' + data.message;
            result.className = 'test-result test-failure';
        }
    })
    .catch(function(err) {
        result.textContent = '[FAIL] ' + err.message;
        result.className = 'test-result test-failure';
    })
    .finally(function() {
        if (window.QWLoading) {
            window.QWLoading.resetBtn(btn);
        } else {
            btn.disabled = false;
            btn.textContent = 'Test Connection';
        }
    });
}

// Run on page load to show correct fields
toggleProviderFields();
</script>

<!-- Standards Set Selection (BL-022) -->
<form method="POST" action="/settings/standards" class="form settings-form" style="margin-top: 2rem;">
    <h2>Standards Set</h2>
    <p class="text-muted">Select which educational standards framework to use for alignment. Standards are rule-based data, not AI-generated.</p>

    <div class="form-group">
        <label for="standard_set">Primary Standard Set</label>
        <select id="standard_set" name="standard_set" class="form-control">
            {% for ss in standard_sets %}
            <option value="{{ ss.key }}" {% if ss.key == current_standard_set %}selected{% endif %}>{{ ss.label }}</option>
            {% endfor %}
        </select>
        <small class="text-muted">Standards are loaded automatically when selected. You can browse all loaded standards on the <a href="/standards">Standards page</a>.</small>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Standards Set</button>
    </div>
</form>

<!-- Accessibility Settings Section (BL-031, BL-033) -->
<div class="a11y-settings-section" id="accessibility-settings">
    <h2>Accessibility</h2>
    <p class="text-muted">Customize display settings for improved readability and accessibility. These preferences are saved in your browser.</p>

    <div class="a11y-toggle-group">
        <div class="a11y-toggle-item">
            <div>
                <label for="a11y-dyslexia-font">
                    <input type="checkbox" id="a11y-dyslexia-font">
                    Dyslexia-Friendly Font (OpenDyslexic)
                </label>
                <p class="a11y-description">Uses OpenDyslexic, a typeface designed to increase readability for readers with dyslexia. Applies to all text including quiz questions and study materials.</p>
                <div class="a11y-preview" id="a11y-preview-font">
                    The quick brown fox jumps over the lazy dog. This is how quiz questions and study material text will appear.
                </div>
            </div>
        </div>

        <div class="a11y-toggle-item">
            <div>
                <label for="a11y-dyslexia-spacing">
                    <input type="checkbox" id="a11y-dyslexia-spacing">
                    Enhanced Spacing
                </label>
                <p class="a11y-description">Increases letter spacing (0.12em), word spacing (0.16em), and line height (1.8) for improved readability.</p>
                <div class="a11y-preview" id="a11y-preview-spacing">
                    The quick brown fox jumps over the lazy dog. This preview shows how enhanced spacing affects readability.
                </div>
            </div>
        </div>

        <div class="a11y-toggle-item">
            <div>
                <label for="a11y-color-blind">
                    <input type="checkbox" id="a11y-color-blind">
                    Color Blind Safe Mode
                </label>
                <p class="a11y-description">Replaces the default color palette with the Wong palette, optimized for all types of color vision deficiency. Adds text-based indicators alongside color cues.</p>
            </div>
        </div>
    </div>
</div>

<script>
// --- Accessibility Preference Management ---
(function() {
    var STORAGE_KEY = 'qw-a11y';

    function loadPrefs() {
        try {
            return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        } catch(e) { return {}; }
    }

    function savePrefs(prefs) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
    }

    function applyPrefs(prefs) {
        document.body.classList.toggle('dyslexia-font', !!prefs.dyslexiaFont);
        document.body.classList.toggle('dyslexia-spacing', !!prefs.dyslexiaSpacing);
        document.body.classList.toggle('color-blind-mode', !!prefs.colorBlind);
    }

    function updatePreviews(prefs) {
        var fontPreview = document.getElementById('a11y-preview-font');
        var spacingPreview = document.getElementById('a11y-preview-spacing');
        if (fontPreview) {
            fontPreview.classList.toggle('visible', !!prefs.dyslexiaFont);
            fontPreview.classList.toggle('dyslexia-font', !!prefs.dyslexiaFont);
        }
        if (spacingPreview) {
            spacingPreview.classList.toggle('visible', !!prefs.dyslexiaSpacing);
            spacingPreview.classList.toggle('dyslexia-spacing', !!prefs.dyslexiaSpacing);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        var prefs = loadPrefs();
        var fontCb = document.getElementById('a11y-dyslexia-font');
        var spacingCb = document.getElementById('a11y-dyslexia-spacing');
        var colorCb = document.getElementById('a11y-color-blind');

        // Initialize checkboxes from saved prefs
        if (fontCb) fontCb.checked = !!prefs.dyslexiaFont;
        if (spacingCb) spacingCb.checked = !!prefs.dyslexiaSpacing;
        if (colorCb) colorCb.checked = !!prefs.colorBlind;

        updatePreviews(prefs);

        // Bind change handlers
        if (fontCb) fontCb.addEventListener('change', function() {
            prefs.dyslexiaFont = this.checked;
            savePrefs(prefs);
            applyPrefs(prefs);
            updatePreviews(prefs);
        });
        if (spacingCb) spacingCb.addEventListener('change', function() {
            prefs.dyslexiaSpacing = this.checked;
            savePrefs(prefs);
            applyPrefs(prefs);
            updatePreviews(prefs);
        });
        if (colorCb) colorCb.addEventListener('change', function() {
            prefs.colorBlind = this.checked;
            savePrefs(prefs);
            applyPrefs(prefs);
        });
    });
})();
</script>
{% endblock %}
