{% extends "base.html" %}
{% block title %}Generate Quiz - {{ class_obj.name }} - QuizWeaver{% endblock %}

{% block content %}
<h1>Generate Quiz - {{ class_obj.name }}</h1>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

<form method="POST" action="/classes/{{ class_obj.id }}/generate" class="form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <div class="form-group">
        <label for="num_questions">Number of Questions <span class="help-tip" data-tip="Number of questions to generate (1-50). Default is 20.">?</span></label>
        <input type="number" id="num_questions" name="num_questions" value="20" min="1" max="50" required>
    </div>
    <div class="form-group">
        <label for="grade_level">Grade Level <span class="help-tip" data-tip="Used to calibrate quiz difficulty and vocabulary level">?</span></label>
        <input type="text" id="grade_level" name="grade_level" value="{{ class_obj.grade_level or '' }}" placeholder="e.g., 7th Grade">
    </div>
    <div class="form-group">
        <label for="sol_standards_search">Standards (optional) <span class="help-tip" data-tip="Search for SOL standards by code or keyword. Pre-filled from class settings if available.">?</span></label>
        <div class="standards-picker">
            <input type="text" id="sol_standards_search" class="picker-input" placeholder="Type to search (e.g., SOL 7.1, fractions, reading)..." autocomplete="off">
            <input type="hidden" id="sol_standards_val" name="sol_standards" value="{{ class_obj.standards|ensure_list|join(', ') if class_obj.standards else '' }}">
            <div class="picker-hint">Search the standards database or type a custom code and press Enter.</div>
        </div>
        <div class="standards-chips" id="sol_standards_chips"></div>
    </div>
    <div class="form-group">
        <label>Cognitive Framework <span class="help-tip" data-tip="{{ ai_tips.cognitive_framework }}">?</span></label>
        <div class="radio-group">
            <label><input type="radio" name="cognitive_framework_radio" value="" checked> None</label>
            <label><input type="radio" name="cognitive_framework_radio" value="blooms"> Bloom's Taxonomy</label>
            <label><input type="radio" name="cognitive_framework_radio" value="dok"> Webb's DOK</label>
        </div>
        <input type="hidden" id="cognitive_framework" name="cognitive_framework" value="">
    </div>

    <div class="form-group" id="cognitive-distribution-group" style="display:none">
        <label>Question Distribution by Level</label>
        <table class="cognitive-table" id="cognitive-table">
            <thead>
                <tr>
                    <th>Level</th>
                    <th>Count</th>
                    <th>Question Types</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <td><strong>Total</strong></td>
                    <td class="cognitive-total"><span id="cognitive-total">0</span> / <span id="cognitive-target">20</span></td>
                    <td><span class="validation-msg" id="validation-msg"></span></td>
                </tr>
            </tfoot>
        </table>
        <input type="hidden" id="cognitive_distribution" name="cognitive_distribution" value="">
    </div>

    <div class="form-group">
        <label for="difficulty">Difficulty Level</label>
        <input type="range" id="difficulty" name="difficulty" min="1" max="5" value="3">
        <span id="difficulty-label">3 - Moderate</span>
    </div>

    {% if providers is defined and providers %}
    <div class="form-group">
        <label for="provider">LLM Provider <span class="help-tip" data-tip="{{ ai_tips.provider_selection }}">?</span></label>
        <select id="provider" name="provider">
            <option value="">Use default ({{ current_provider|default('mock') }})</option>
            {% for p in providers %}
            <option value="{{ p.key }}" {% if not p.available %}disabled{% endif %}>
                {{ p.label }}{% if not p.available %} (not configured){% endif %}
            </option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <div id="cost-estimate" class="cost-estimate-box" style="display:none" role="status" aria-live="polite">
        <span id="cost-estimate-text"></span>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Generate Quiz</button>
        <a href="/classes/{{ class_obj.id }}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<div id="generate-progress" class="generate-progress" style="display:none" role="status" aria-live="polite">
    <div class="progress-card">
        <h2 id="progress-title">Generating Quiz...</h2>
        <p class="progress-subtitle">Here's what QuizWeaver is doing:</p>
        <ul class="progress-checklist" id="progress-checklist">
            <li id="step-0" data-desc="Validating your settings and preparing the generation request">
                <span class="step-icon step-pending"></span>
                <span class="step-label">Preparing request</span>
                <span class="step-desc">Validating settings and building configuration</span>
            </li>
            <li id="step-1" data-desc="Pulling recent lessons, topics taught, and assumed student knowledge for this class">
                <span class="step-icon step-pending"></span>
                <span class="step-label">Loading class context</span>
                <span class="step-desc">Retrieving lesson history and assumed knowledge</span>
            </li>
            <li id="step-2" data-desc="Establishing a connection to the selected language model">
                <span class="step-icon step-pending"></span>
                <span class="step-label">Connecting to language model</span>
                <span class="step-desc">Sending prompt to <strong id="provider-name-display">your language model</strong></span>
            </li>
            <li id="step-3" data-desc="The Generator Agent is crafting questions matched to your grade level, standards, and cognitive framework">
                <span class="step-icon step-pending"></span>
                <span class="step-label">Generating questions</span>
                <span class="step-desc">Generator Agent is crafting questions from your content</span>
            </li>
            <li id="step-4" data-desc="The Critic Agent reviews each question for quality, alignment with standards, and grade-level appropriateness">
                <span class="step-icon step-pending"></span>
                <span class="step-label">Quality review</span>
                <span class="step-desc">Critic Agent checking alignment, accuracy, and quality</span>
            </li>
            <li id="step-5" data-desc="Storing the approved questions in the database and finalizing the quiz record">
                <span class="step-icon step-pending"></span>
                <span class="step-label">Saving quiz</span>
                <span class="step-desc">Storing questions and finalizing your quiz</span>
            </li>
        </ul>
        <div id="progress-error" class="progress-error" style="display:none">
            <strong>Generation failed</strong>
            <p id="progress-error-msg"></p>
            <a href="" class="btn btn-primary" id="progress-retry-btn">Try Again</a>
        </div>
        <p class="progress-hint" id="progress-hint">This may take 15-60 seconds depending on your provider and question count.</p>
    </div>
</div>

<script src="/static/js/cognitive_form.js"></script>
<script>
// Cost estimate updater
(function() {
    var estimateBox = document.getElementById('cost-estimate');
    var estimateText = document.getElementById('cost-estimate-text');
    var providerSelect = document.getElementById('provider');
    var numInput = document.getElementById('num_questions');
    var debounceTimer = null;

    function updateEstimate() {
        var provider = (providerSelect && providerSelect.value) ? providerSelect.value : '';
        var numQuestions = numInput ? numInput.value : 10;
        var url = '/api/estimate-cost?num_questions=' + encodeURIComponent(numQuestions);
        if (provider) url += '&provider=' + encodeURIComponent(provider);

        fetch(url)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.is_mock) {
                    estimateText.textContent = 'Free (mock mode)';
                    estimateBox.className = 'cost-estimate-box cost-estimate-free';
                } else {
                    var text = 'Estimated cost: ' + data.estimated_cost;
                    if (data.estimated_tokens) {
                        text += ' (~' + data.estimated_tokens.toLocaleString() + ' tokens)';
                    }
                    estimateText.textContent = text;
                    if (data.estimated_cost_raw && data.estimated_cost_raw > 0.10) {
                        estimateBox.className = 'cost-estimate-box cost-estimate-warning';
                    } else {
                        estimateBox.className = 'cost-estimate-box cost-estimate-normal';
                    }
                }
                estimateBox.style.display = 'block';
            })
            .catch(function() {
                estimateBox.style.display = 'none';
            });
    }

    function debouncedUpdate() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(updateEstimate, 300);
    }

    if (providerSelect) providerSelect.addEventListener('change', debouncedUpdate);
    if (numInput) numInput.addEventListener('input', debouncedUpdate);

    // Initial fetch on page load
    updateEstimate();
})();
</script>
<script>
(function() {
    var form = document.querySelector('form.form');
    var overlay = document.getElementById('generate-progress');
    var checklist = document.getElementById('progress-checklist');
    var titleEl = document.getElementById('progress-title');
    var hintEl = document.getElementById('progress-hint');
    var errorEl = document.getElementById('progress-error');
    var errorMsg = document.getElementById('progress-error-msg');
    var retryBtn = document.getElementById('progress-retry-btn');
    var providerDisplay = document.getElementById('provider-name-display');
    var totalSteps = 6;
    var currentStep = 0;
    var timers = [];
    var finished = false;

    function setStepState(idx, state) {
        var li = document.getElementById('step-' + idx);
        if (!li) return;
        var icon = li.querySelector('.step-icon');
        icon.className = 'step-icon step-' + state;
        li.classList.remove('step-active', 'step-complete', 'step-failed');
        if (state === 'active') li.classList.add('step-active');
        else if (state === 'done') li.classList.add('step-complete');
        else if (state === 'error') li.classList.add('step-failed');
    }

    function advanceTo(idx) {
        if (finished || idx >= totalSteps) return;
        // Complete all previous steps
        for (var i = 0; i < idx; i++) {
            setStepState(i, 'done');
        }
        // Mark current as active
        setStepState(idx, 'active');
        currentStep = idx;
    }

    function completeAll() {
        finished = true;
        for (var i = 0; i < totalSteps; i++) {
            setStepState(i, 'done');
        }
        titleEl.textContent = 'Quiz Generated!';
        hintEl.textContent = 'Redirecting to your quiz...';
    }

    function showError(msg) {
        finished = true;
        // Mark current step as failed
        setStepState(currentStep, 'error');
        // Mark remaining as skipped
        for (var i = currentStep + 1; i < totalSteps; i++) {
            setStepState(i, 'skipped');
        }
        titleEl.textContent = 'Generation Failed';
        hintEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorMsg.textContent = msg || 'An unexpected error occurred. Please try again.';
        retryBtn.href = window.location.href;
    }

    function clearTimers() {
        for (var i = 0; i < timers.length; i++) clearTimeout(timers[i]);
        timers = [];
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        overlay.style.display = 'flex';

        // Show selected provider's friendly name
        var providerSelect = document.getElementById('provider');
        if (providerSelect) {
            var selected = providerSelect.options[providerSelect.selectedIndex];
            // Use the option label text, stripping "(not configured)" etc.
            var name = selected.value
                ? selected.text.replace(/\s*\(.*\)\s*$/, '')
                : '{{ current_provider|default("mock") }}';
            providerDisplay.textContent = name;
        }

        // Animate through steps on a schedule (spread out for real providers)
        var isMock = !providerSelect || !providerSelect.value;
        var delays = isMock
            ? [0, 500, 1000, 1500, 2500, 3500]
            : [0, 1500, 3000, 6000, 25000, 50000];
        for (var i = 0; i < delays.length; i++) {
            (function(idx, delay) {
                timers.push(setTimeout(function() { advanceTo(idx); }, delay));
            })(i, delays[i]);
        }

        // Update hint after a while so user knows it's still working
        if (!isMock) {
            timers.push(setTimeout(function() {
                if (!finished) hintEl.textContent = 'Still working... language model providers can take up to 2 minutes for large quizzes.';
            }, 20000));
            timers.push(setTimeout(function() {
                if (!finished) hintEl.textContent = 'Almost there... the critic agent is reviewing and refining your questions.';
            }, 45000));
        }

        // Submit via fetch
        var formData = new FormData(form);
        fetch(form.action, {
            method: 'POST',
            headers: {'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')},
            body: formData,
            redirect: 'follow',
        })
        .then(function(response) {
            clearTimers();
            if (response.redirected) {
                // Success - server redirected to quiz detail
                completeAll();
                setTimeout(function() {
                    window.location.href = response.url;
                }, 800);
            } else {
                // Server returned the form page again (error)
                return response.text().then(function(html) {
                    var match = html.match(/class="alert alert-error">(.*?)<\/div>/);
                    var msg = match ? match[1] : 'Quiz generation failed. Check your provider settings and try again.';
                    showError(msg);
                });
            }
        })
        .catch(function(err) {
            clearTimers();
            showError('Network error: ' + err.message);
        });
    });
})();
</script>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/standards_picker.css') }}">
<script src="{{ url_for('static', filename='js/standards_picker.js') }}"></script>
<script>
initStandardsPicker({
    inputId: 'sol_standards_search',
    hiddenInputId: 'sol_standards_val',
    chipsContainerId: 'sol_standards_chips',
    apiUrl: '/api/standards/search',
    initialValues: {{ (class_obj.standards|ensure_list if class_obj.standards else [])|tojson }}
});
</script>
{% endblock %}
