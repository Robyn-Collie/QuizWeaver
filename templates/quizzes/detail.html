{% extends "base.html" %}
{% block title %}{{ quiz.title }} - QuizWeaver{% endblock %}

{% block content %}
<div class="quiz-title-row">
    <h1 class="quiz-title-display" data-quiz-id="{{ quiz.id }}">{{ quiz.title }}</h1>
    <button class="btn btn-sm btn-outline edit-title-btn" title="Edit title">Edit Title</button>
</div>
<div class="quiz-title-edit" style="display:none;" data-quiz-id="{{ quiz.id }}">
    <label for="quiz-title-input" class="sr-only">Quiz title</label>
    <input type="text" id="quiz-title-input" class="quiz-title-input" value="{{ quiz.title }}" />
    <button class="btn btn-sm btn-primary save-title-btn">Save</button>
    <button class="btn btn-sm btn-secondary cancel-title-btn">Cancel</button>
</div>

<div class="ai-notice" data-dismiss-key="quiz-detail">
    <button class="ai-notice-dismiss" aria-label="Dismiss notice" title="Dismiss">&times;</button>
    <strong>LLM-Generated Content:</strong> This quiz was generated by a language model. Please review all questions for accuracy, bias, and appropriateness before sharing with students.
    <br><small>Learn more: <a href="/help#understanding-ai">Understanding Language Models in QuizWeaver</a></small>
</div>

<div class="quiz-info">
    <p><strong>Status:</strong> <span class="status status-{{ quiz.status }}">{{ quiz.status }}</span></p>
    {% if quiz.status == 'needs_review' %}
    <div class="needs-review-warning">
        <strong>Needs Review:</strong> This quiz was not approved by the quality reviewer. Please review each question carefully before use.
    </div>
    {% endif %}
    {% if quiz.reading_level %}
    <p><strong>Reading Level:</strong> <span class="reading-level-badge reading-level-{{ quiz.reading_level }}">{{ quiz.reading_level|replace('_', ' ')|title }}</span></p>
    {% endif %}
    {% if class_obj %}<p><strong>Class:</strong> <a href="/classes/{{ class_obj.id }}">{{ class_obj.name }}</a></p>{% endif %}
    <p><strong>Questions:</strong> <span id="question-count">{{ questions | length }}</span></p>
    {% if style_profile and style_profile.sol_standards is defined and style_profile.sol_standards %}
    <p><strong>Standards:</strong> {{ style_profile.sol_standards|ensure_list|join(', ') }}</p>
    {% endif %}
    {% if style_profile and style_profile.cognitive_framework is defined and style_profile.cognitive_framework %}
    <p><strong>Framework:</strong> {{ style_profile.cognitive_framework|capitalize }}</p>
    {% endif %}
    {% if style_profile and style_profile.difficulty is defined and style_profile.difficulty %}
    <p><strong>Difficulty:</strong> {{ style_profile.difficulty }}/5</p>
    {% endif %}
    {% if style_profile and style_profile.provider is defined and style_profile.provider %}
    <p><strong>Generated by:</strong> {{ style_profile.provider }}</p>
    {% endif %}
</div>

{# Glass Box: Generation Transparency (BL-040, BL-041) #}
{% if generation_metadata %}
<details class="glass-box-section">
    <summary><strong>How This Quiz Was Generated</strong> <span class="glass-box-badge">Glass Box</span></summary>

    <div class="glass-box-content">
        {# BL-040: Prompt Summary #}
        {% if generation_metadata.prompt_summary %}
        <div class="glass-box-subsection">
            <h3>Generation Parameters</h3>
            <ul class="glass-box-params">
                {% if generation_metadata.prompt_summary.grade_level %}
                <li><strong>Grade Level:</strong> {{ generation_metadata.prompt_summary.grade_level }}</li>
                {% endif %}
                {% if generation_metadata.prompt_summary.num_questions %}
                <li><strong>Questions Requested:</strong> {{ generation_metadata.prompt_summary.num_questions }}</li>
                {% endif %}
                {% if generation_metadata.prompt_summary.standards %}
                <li><strong>Standards Targeted:</strong> {{ generation_metadata.prompt_summary.standards|join(', ') }}</li>
                {% endif %}
                {% if generation_metadata.prompt_summary.cognitive_framework %}
                <li><strong>Cognitive Framework:</strong> {{ generation_metadata.prompt_summary.cognitive_framework|capitalize }}</li>
                {% endif %}
                {% if generation_metadata.prompt_summary.difficulty %}
                <li><strong>Difficulty:</strong> {{ generation_metadata.prompt_summary.difficulty }}/5</li>
                {% endif %}
                {% if generation_metadata.prompt_summary.topics_from_lessons %}
                <li><strong>Topics from Recent Lessons:</strong> {{ generation_metadata.prompt_summary.topics_from_lessons|join(', ') }}</li>
                {% endif %}
            </ul>
        </div>
        {% endif %}

        {# BL-040: Pipeline Metrics #}
        {% if generation_metadata.metrics %}
        <div class="glass-box-subsection">
            <h3>Pipeline Metrics</h3>
            <ul class="glass-box-params">
                <li><strong>Provider:</strong> {{ generation_metadata.provider or 'unknown' }}</li>
                {% if generation_metadata.model %}
                <li><strong>Model:</strong> {{ generation_metadata.model }}</li>
                {% endif %}
                <li><strong>LLM Calls:</strong> {{ generation_metadata.metrics.total_llm_calls }} ({{ generation_metadata.metrics.generator_calls }} generation, {{ generation_metadata.metrics.critic_calls }} review)</li>
                <li><strong>Attempts:</strong> {{ generation_metadata.metrics.attempts }}</li>
                <li><strong>Duration:</strong> {{ generation_metadata.metrics.duration_seconds }}s</li>
                <li><strong>Final Status:</strong> {% if generation_metadata.metrics.approved %}<span class="status status-generated">Approved by critic</span>{% else %}<span class="status status-pending">Max retries reached</span>{% endif %}</li>
            </ul>
        </div>
        {% endif %}

        {# BL-042: Generation Cost #}
        {% if generation_metadata.token_usage %}
        <div class="glass-box-subsection">
            <h3>Generation Cost</h3>
            {% if generation_metadata.token_usage.is_mock %}
            <p class="cost-mock-notice">$0.00 (mock mode -- no API costs)</p>
            {% else %}
            <ul class="glass-box-params">
                <li><strong>Input Tokens:</strong> {{ "{:,}".format(generation_metadata.token_usage.input_tokens) }}</li>
                <li><strong>Output Tokens:</strong> {{ "{:,}".format(generation_metadata.token_usage.output_tokens) }}</li>
                <li><strong>Total Tokens:</strong> {{ "{:,}".format(generation_metadata.token_usage.total_tokens) }}</li>
                <li><strong>Estimated Cost:</strong> ${{ "%.4f"|format(generation_metadata.token_usage.estimated_cost) }}</li>
            </ul>
            {% endif %}
            <p class="glass-box-note">Token counts {% if generation_metadata.token_usage.is_mock %}are zero in mock mode. Switch to a real provider to see actual costs.{% else %}are reported by the language model provider. Cost is estimated from published pricing.{% endif %}</p>
        </div>
        {% endif %}

        {# BL-041: Critic Feedback History #}
        {% if generation_metadata.critic_history %}
        <div class="glass-box-subsection">
            <h3>Quality Review History</h3>
            <p class="glass-box-note">The critic agent reviewed the generated questions for quality, accuracy, and alignment. Here is what happened:</p>
            {% for entry in generation_metadata.critic_history %}
            <div class="critic-entry critic-{{ entry.status|lower }}">
                <strong>Attempt {{ entry.attempt }}:</strong>
                <span class="status status-{% if entry.status == 'APPROVED' %}generated{% else %}failed{% endif %}">{{ entry.status }}</span>
                {% if entry.feedback %}
                <p class="critic-feedback">{{ entry.feedback[:500] }}{% if entry.feedback|length > 500 %}...{% endif %}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</details>
{% endif %}

{# Variant lineage #}
{% if parent_quiz %}
<div class="variant-lineage">
    <strong>Source Quiz:</strong> <a href="/quizzes/{{ parent_quiz.id }}">{{ parent_quiz.title }}</a>
</div>
{% endif %}
{% if variant_count and variant_count > 0 %}
<div class="variant-lineage">
    <strong>Variants:</strong> <a href="/quizzes/{{ quiz.id }}/variants">{{ variant_count }} variant{{ 's' if variant_count != 1 }}</a>
</div>
{% endif %}

<div class="export-actions">
    <button class="btn-print" onclick="window.print()">Print</button>

    <span class="export-label">Teacher Copy (with answers):</span>
    <a href="/quizzes/{{ quiz.id }}/export/docx" class="btn btn-sm btn-outline">Word</a>
    <a href="/quizzes/{{ quiz.id }}/export/pdf" class="btn btn-sm btn-outline">PDF</a>
    <a href="/quizzes/{{ quiz.id }}/export/csv" class="btn btn-sm btn-outline">CSV</a>

    <span class="export-label">Student Copy (no answers):</span>
    <a href="/quizzes/{{ quiz.id }}/export/docx?student=1" class="btn btn-sm btn-outline">Word</a>
    <a href="/quizzes/{{ quiz.id }}/export/pdf?student=1" class="btn btn-sm btn-outline">PDF</a>

    <span class="export-label">LMS Import:</span>
    <a href="/quizzes/{{ quiz.id }}/export/gift" class="btn btn-sm btn-outline">GIFT (Moodle)</a>
    <a href="/quizzes/{{ quiz.id }}/export/qti" class="btn btn-sm btn-outline">QTI (Canvas)</a>
    <a href="/quizzes/{{ quiz.id }}/export/quizizz" class="btn btn-sm btn-outline">Quizizz CSV</a>
    <a href="/quizzes/{{ quiz.id }}/export-template" class="btn btn-sm btn-outline">Export as Template</a>
</div>

<div class="section-actions">
    <a href="/quizzes/{{ quiz.id }}/generate-variant" class="btn btn-sm btn-secondary">Generate Variant</a>
    <a href="/quizzes/{{ quiz.id }}/generate-rubric" class="btn btn-sm btn-secondary">Generate Rubric</a>
</div>

{# Rubrics for this quiz #}
{% if rubrics %}
<div class="rubric-list-section">
    <h2>Rubrics</h2>
    {% for r in rubrics %}
    <div class="rubric-card">
        <a href="/rubrics/{{ r.id }}">{{ r.title }}</a>
        <span class="status status-{{ r.status }}">{{ r.status }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- TTS Panel (BL-032) -->
<div class="tts-panel collapsed" id="ttsPanel">
    <div class="tts-panel-header">
        <h3>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
            Read Aloud
        </h3>
        <button class="tts-toggle-btn" aria-label="Toggle TTS panel" aria-expanded="false">+</button>
    </div>
    <div class="tts-controls">
        <button class="tts-btn" id="ttsPlayBtn" aria-label="Play speech">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            Play All
        </button>
        <button class="tts-btn" id="ttsStopBtn" aria-label="Stop speech">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><rect x="4" y="4" width="16" height="16"/></svg>
            Stop
        </button>
        <label for="ttsSpeedSlider">Speed:</label>
        <input type="range" id="ttsSpeedSlider" min="0.5" max="2" step="0.1" value="1.0" aria-label="Speech speed">
        <span class="tts-speed-value" id="ttsSpeedValue">1.0x</span>
        <label for="ttsVoiceSelect">Voice:</label>
        <select id="ttsVoiceSelect" aria-label="Select voice">
            <option value="">Default</option>
        </select>
    </div>
</div>

<h2>Questions <span class="help-tip" data-tip="{{ ai_tips.review_reminder }}">?</span></h2>
{% for q in questions %}
<div class="question-card" data-question-id="{{ q.id }}" data-quiz-id="{{ quiz.id }}">
    <div class="question-header">
        <span class="question-number">Q<span class="q-index">{{ loop.index }}</span></span>
        <span class="question-type">{{ q.type or 'unknown' }}</span>
        <span class="question-points">{{ q.points or 0 }} pts</span>
        {% if q.data and q.data.cognitive_level is defined and q.data.cognitive_level %}
        <span class="cognitive-badge cognitive-badge-{{ q.data.cognitive_level_number|default(0) }}">
            {{ q.data.cognitive_level }}
        </span>
        {% endif %}
        <button class="tts-read-btn" title="Read aloud" aria-label="Read this question aloud">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
        </button>
        <span class="question-actions">
            <button class="btn btn-sm btn-outline btn-edit-question" title="Edit" aria-label="Edit question">Edit</button>
            <button class="btn btn-sm btn-outline btn-move-up" title="Move up" aria-label="Move question up">Up</button>
            <button class="btn btn-sm btn-outline btn-move-down" title="Move down" aria-label="Move question down">Down</button>
            <button class="btn btn-sm btn-outline btn-regen-question" title="Regenerate" aria-label="Regenerate question">Regen</button>
            <button class="btn btn-sm btn-outline btn-upload-image" title="Upload image" aria-label="Upload image">Image</button>
            <button class="btn btn-sm {% if q.saved_to_bank %}btn-secondary{% else %}btn-outline{% endif %} btn-bank-toggle"
                    title="{% if q.saved_to_bank %}Remove from Bank{% else %}Save to Bank{% endif %}"
                    aria-label="{% if q.saved_to_bank %}Remove from question bank{% else %}Save to question bank{% endif %}"
                    data-saved="{{ 'true' if q.saved_to_bank else 'false' }}">
                {% if q.saved_to_bank %}Banked{% else %}Bank{% endif %}
            </button>
            <button class="btn btn-sm btn-danger btn-delete-question" title="Delete" aria-label="Delete question">Delete</button>
            <input type="file" class="image-file-input" accept=".png,.jpg,.jpeg,.gif,.webp" style="display:none;">
        </span>
    </div>

    {# --- View mode --- #}
    <div class="question-view-mode">
        <p class="question-text">{{ q.text }}</p>

        {% if q.data and q.data.image_ref is defined and q.data.image_ref %}
        <div class="question-image-wrapper">
            <img src="/generated_images/{{ q.data.image_ref }}" alt="Question image" class="question-image"
                 onerror="this.style.display='none'">
            <button class="btn btn-sm btn-outline btn-remove-image" aria-label="Remove question image">Remove Image</button>
        </div>
        {% elif q.data and q.data.image_description is defined and q.data.image_description %}
        <div class="image-placeholder">
            <strong>Suggested image:</strong> {{ q.data.image_description }}
            <button class="btn-clear-image-desc" title="Remove suggested image" aria-label="Remove suggested image description">&times;</button>
        </div>
        {% elif q.data and q.data.image is defined and q.data.image %}
        <div class="question-image-external" data-src="{{ q.data.image }}">
            <img src="{{ q.data.image }}" alt="Question image" class="question-image" referrerpolicy="no-referrer"
                 onerror="this.parentElement.innerHTML='<span class=\'image-placeholder\'>Image unavailable. Consider uploading your own.</span>'">
        </div>
        {% endif %}

        {% if q.type == 'matching' or (q.data and q.data.question_type is defined and q.data.question_type == 'matching') %}
        {# --- Matching question display --- #}
        {% set matches = q.data.matches if q.data.matches is defined else [] %}
        {% if matches %}
        <table class="matching-table">
            <thead>
                <tr><th>Term</th><th>Definition</th></tr>
            </thead>
            <tbody>
                {% for m in matches %}
                <tr>
                    <td>{{ m.term }}</td>
                    <td>{{ m.definition }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% elif q.data.prompt_items is defined and q.data.response_items is defined %}
        <div class="matching-columns">
            <div class="matching-col">
                <strong>Terms:</strong>
                <ol>{% for item in q.data.prompt_items %}<li>{{ item }}</li>{% endfor %}</ol>
            </div>
            <div class="matching-col">
                <strong>Definitions:</strong>
                <ol type="A">{% for item in q.data.response_items %}<li>{{ item }}</li>{% endfor %}</ol>
            </div>
        </div>
        {% endif %}

        {% elif q.data and q.data.question_type is defined and q.data.question_type == 'ordering' %}
        {# --- Ordering question display --- #}
        {% if q.data.instructions is defined and q.data.instructions %}
        <p class="ordering-instructions"><em>{{ q.data.instructions }}</em></p>
        {% endif %}
        <ol class="ordering-items">
            {% for item in q.data['items'] %}
            <li>{{ item }}</li>
            {% endfor %}
        </ol>
        <div class="question-answer">
            <strong>Correct Order:</strong>
            {% if q.data.correct_order is defined %}
            {% for idx in q.data.correct_order %}{% if idx < q.data['items']|length %}{% if not loop.first %} &rarr; {% endif %}{{ q.data['items'][idx] }}{% endif %}{% endfor %}
            {% endif %}
        </div>

        {% elif q.data and q.data.question_type is defined and q.data.question_type == 'short_answer' %}
        {# --- Short answer question display --- #}
        <div class="short-answer-blank">
            <p>________________________________________</p>
        </div>
        <div class="question-answer">
            <strong>Expected Answer:</strong> {{ q.data.expected_answer or '' }}
            {% if q.data.acceptable_answers is defined and q.data.acceptable_answers %}
            <br><strong>Also accepted:</strong> {{ q.data.acceptable_answers|join(', ') }}
            {% endif %}
            {% if q.data.rubric_hint is defined and q.data.rubric_hint %}
            <br><em>Rubric hint: {{ q.data.rubric_hint }}</em>
            {% endif %}
        </div>

        {% elif q.type == 'tf' or q.question_type == 'tf' %}
        <div class="tf-answer">
            <span class="tf-option {% if q.data.correct_answer == 'True' or q.data.answer == 'True' %}correct{% endif %}">True</span>
            <span class="tf-option {% if q.data.correct_answer == 'False' or q.data.answer == 'False' %}correct{% endif %}">False</span>
        </div>
        {% elif q.data and q.data.options is defined %}
        <ul class="question-options">
            {% for option in q.data.options %}
            {% if option is mapping %}
            <li{% if q.data.correct_answers is defined and option.id in q.data.correct_answers %} class="correct"{% endif %}>
                <strong>{{ option.id }}.</strong> {{ option.text }}
            </li>
            {% else %}
            <li{% if q.data.correct_answer is defined and option == q.data.correct_answer %} class="correct"{% elif q.data.correct_index is defined and loop.index0 == q.data.correct_index %} class="correct"{% endif %}>
                {{ option }}
            </li>
            {% endif %}
            {% endfor %}
        </ul>
        {% endif %}

        {# Word bank for fill-in questions #}
        {% if q.data and q.data.word_bank is defined and q.data.word_bank %}
        <div class="word-bank">
            <strong>Word Bank:</strong> {{ q.data.word_bank|join(', ') }}
        </div>
        {% endif %}

        {% if q.data %}
        {% set answer = q.data.correct_answer or q.data.answer or none %}
        {% if answer and q.type != 'tf' and q.question_type != 'tf' and (q.data.question_type is not defined or q.data.question_type not in ['ordering', 'short_answer']) %}
        <div class="question-answer">
            <strong>Answer:</strong> {{ answer }}
        </div>
        {% endif %}
        {% endif %}
    </div>

    {# --- Edit mode (hidden by default) --- #}
    <div class="question-edit-mode" style="display:none;">
        <div class="form-group">
            <label>Question Text</label>
            <textarea class="edit-question-text" rows="3">{{ q.text }}</textarea>
        </div>
        <div class="edit-row">
            <div class="form-group form-group-inline">
                <label>Points</label>
                <input type="number" class="edit-question-points" value="{{ q.points or 1 }}" min="0" step="0.5">
            </div>
            <div class="form-group form-group-inline">
                <label>Type</label>
                <select class="edit-question-type">
                    <option value="mc" {% if q.type == 'mc' %}selected{% endif %}>Multiple Choice</option>
                    <option value="tf" {% if q.type == 'tf' %}selected{% endif %}>True/False</option>
                    <option value="ma" {% if q.type == 'ma' %}selected{% endif %}>Multiple Answer</option>
                    <option value="fill_in_blank" {% if q.type == 'fill_in_blank' %}selected{% endif %}>Fill in Blank</option>
                    <option value="short_answer" {% if q.type == 'short_answer' %}selected{% endif %}>Short Answer</option>
                    <option value="ordering" {% if q.type == 'ordering' %}selected{% endif %}>Ordering</option>
                    <option value="matching" {% if q.type == 'matching' %}selected{% endif %}>Matching</option>
                    <option value="essay" {% if q.type == 'essay' %}selected{% endif %}>Essay</option>
                </select>
            </div>
        </div>

        {# MC/MA options editor #}
        <div class="edit-options-section" {% if q.type not in ('mc', 'ma') and q.type != none %}style="display:none;"{% endif %}>
            <label>Options</label>
            <div class="edit-options-list">
                {% if q.data and q.data.options is defined %}
                {% for option in q.data.options %}
                <div class="edit-option-row">
                    <input type="radio" name="correct_{{ q.id }}" class="edit-correct-radio" value="{{ loop.index0 }}"
                           {% if q.data.correct_index is defined and loop.index0 == q.data.correct_index %}checked{% endif %}>
                    <input type="text" class="edit-option-text" value="{% if option is mapping %}{{ option.text }}{% else %}{{ option }}{% endif %}">
                    <button class="btn btn-sm btn-outline btn-remove-option" title="Remove option" aria-label="Remove option">x</button>
                </div>
                {% endfor %}
                {% endif %}
            </div>
            <button class="btn btn-sm btn-outline btn-add-option">+ Add Option</button>
        </div>

        {# TF correct answer #}
        <div class="edit-tf-section" {% if q.type != 'tf' %}style="display:none;"{% endif %}>
            <label>Correct Answer</label>
            <div class="radio-group">
                <label><input type="radio" name="tf_{{ q.id }}" class="edit-tf-radio" value="True"
                    {% if q.data and (q.data.correct_answer == 'True' or q.data.answer == 'True') %}checked{% endif %}> True</label>
                <label><input type="radio" name="tf_{{ q.id }}" class="edit-tf-radio" value="False"
                    {% if q.data and (q.data.correct_answer == 'False' or q.data.answer == 'False') %}checked{% endif %}> False</label>
            </div>
        </div>

        <div class="form-actions">
            <button class="btn btn-sm btn-primary btn-save-question">Save</button>
            <button class="btn btn-sm btn-secondary btn-cancel-edit">Cancel</button>
        </div>
    </div>

    {# --- Regenerate panel (hidden by default) --- #}
    <div class="question-regen-panel" style="display:none;">
        <div class="form-group">
            <label>Teacher Notes (optional guidance for the new question)</label>
            <textarea class="regen-notes" rows="2" placeholder="e.g., Make it about cellular respiration instead"></textarea>
        </div>
        <div class="form-actions">
            <button class="btn btn-sm btn-primary btn-regen-submit">Regenerate</button>
            <button class="btn btn-sm btn-secondary btn-regen-cancel">Cancel</button>
        </div>
    </div>
</div>
{% endfor %}

<p><a href="/quizzes">&larr; Back to Quizzes</a></p>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/quiz_edit.js') }}"></script>
<script src="{{ url_for('static', filename='js/tts.js') }}"></script>
{% endblock %}
