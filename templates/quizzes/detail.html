{% extends "base.html" %}
{% block title %}{{ quiz.title }} - QuizWeaver{% endblock %}

{% block content %}
<div class="quiz-title-row">
    <h1 class="quiz-title-display" data-quiz-id="{{ quiz.id }}">{{ quiz.title }}</h1>
    <button class="btn btn-sm btn-outline edit-title-btn" title="Edit title">Edit Title</button>
</div>
<div class="quiz-title-edit" style="display:none;" data-quiz-id="{{ quiz.id }}">
    <label for="quiz-title-input" class="sr-only">Quiz title</label>
    <input type="text" id="quiz-title-input" class="quiz-title-input" value="{{ quiz.title }}" />
    <button class="btn btn-sm btn-primary save-title-btn">Save</button>
    <button class="btn btn-sm btn-secondary cancel-title-btn">Cancel</button>
</div>

<div class="ai-notice" data-dismiss-key="quiz-detail">
    <button class="ai-notice-dismiss" aria-label="Dismiss notice" title="Dismiss">&times;</button>
    <strong>LLM-Generated Content:</strong> This quiz was generated by a language model. Please review all questions for accuracy, bias, and appropriateness before sharing with students.
    <br><small>Learn more: <a href="/help#understanding-ai">Understanding Language Models in QuizWeaver</a></small>
</div>

<div class="quiz-info">
    <p><strong>Status:</strong> <span class="status status-{{ quiz.status }}">{{ quiz.status }}</span></p>
    {% if quiz.status == 'needs_review' %}
    <div class="needs-review-warning">
        <strong>Needs Review:</strong> This quiz was not approved by the quality reviewer. Please review each question carefully before use.
    </div>
    {% endif %}
    {% if quiz.reading_level %}
    <p><strong>Reading Level:</strong> <span class="reading-level-badge reading-level-{{ quiz.reading_level }}">{{ quiz.reading_level|replace('_', ' ')|title }}</span></p>
    {% endif %}
    {% if class_obj %}<p><strong>Class:</strong> <a href="/classes/{{ class_obj.id }}">{{ class_obj.name }}</a></p>{% endif %}
    <p><strong>Questions:</strong> <span id="question-count">{{ questions | length }}</span></p>
    {% if style_profile and style_profile.sol_standards is defined and style_profile.sol_standards %}
    <p><strong>Standards:</strong> {{ style_profile.sol_standards|ensure_list|join(', ') }}</p>
    {% endif %}
    {% if style_profile and style_profile.cognitive_framework is defined and style_profile.cognitive_framework %}
    <p><strong>Framework:</strong> {{ style_profile.cognitive_framework|capitalize }}</p>
    {% endif %}
    {% if style_profile and style_profile.difficulty is defined and style_profile.difficulty %}
    <p><strong>Difficulty:</strong> {{ style_profile.difficulty }}/5</p>
    {% endif %}
    {% if style_profile and style_profile.provider is defined and style_profile.provider %}
    <p><strong>Generated by:</strong> {{ style_profile.provider }}</p>
    {% endif %}
</div>

{# Glass Box: Generation Transparency (BL-040, BL-041) #}
{% if generation_metadata %}
<details class="glass-box-section">
    <summary><strong>How This Quiz Was Generated</strong> <span class="glass-box-badge">Glass Box</span></summary>

    <div class="glass-box-content">
        {# BL-040: Prompt Summary #}
        {% if generation_metadata.prompt_summary %}
        <div class="glass-box-subsection">
            <h2>Generation Parameters</h2>
            <ul class="glass-box-params">
                {% if generation_metadata.prompt_summary.grade_level %}
                <li><strong>Grade Level:</strong> {{ generation_metadata.prompt_summary.grade_level }}</li>
                {% endif %}
                {% if generation_metadata.prompt_summary.num_questions %}
                <li><strong>Questions Requested:</strong> {{ generation_metadata.prompt_summary.num_questions }}</li>
                {% endif %}
                {% if generation_metadata.prompt_summary.standards %}
                <li><strong>Standards Targeted:</strong> {{ generation_metadata.prompt_summary.standards|join(', ') }}</li>
                {% endif %}
                {% if generation_metadata.prompt_summary.cognitive_framework %}
                <li><strong>Cognitive Framework:</strong> {{ generation_metadata.prompt_summary.cognitive_framework|capitalize }}</li>
                {% endif %}
                {% if generation_metadata.prompt_summary.difficulty %}
                <li><strong>Difficulty:</strong> {{ generation_metadata.prompt_summary.difficulty }}/5</li>
                {% endif %}
                {% if generation_metadata.prompt_summary.topics_from_lessons %}
                <li><strong>Topics from Recent Lessons:</strong> {{ generation_metadata.prompt_summary.topics_from_lessons|join(', ') }}</li>
                {% endif %}
            </ul>
        </div>
        {% endif %}

        {# BL-040: Pipeline Metrics #}
        {% if generation_metadata.metrics %}
        <div class="glass-box-subsection">
            <h2>Pipeline Metrics</h2>
            <ul class="glass-box-params">
                <li><strong>Provider:</strong> {{ generation_metadata.provider or 'unknown' }}</li>
                {% if generation_metadata.model %}
                <li><strong>Model:</strong> {{ generation_metadata.model }}</li>
                {% endif %}
                <li><strong>LLM Calls:</strong> {{ generation_metadata.metrics.total_llm_calls }} ({{ generation_metadata.metrics.generator_calls }} generation, {{ generation_metadata.metrics.critic_calls }} review)</li>
                <li><strong>Attempts:</strong> {{ generation_metadata.metrics.attempts }}</li>
                <li><strong>Duration:</strong> {{ generation_metadata.metrics.duration_seconds }}s</li>
                <li><strong>Final Status:</strong> {% if generation_metadata.metrics.approved %}<span class="status status-generated">Approved by critic</span>{% else %}<span class="status status-pending">Max retries reached</span>{% endif %}</li>
            </ul>
        </div>
        {% endif %}

        {# BL-042: Generation Cost #}
        {% if generation_metadata.token_usage %}
        <div class="glass-box-subsection">
            <h2>Generation Cost</h2>
            {% if generation_metadata.token_usage.is_mock %}
            <p class="cost-mock-notice">$0.00 (mock mode -- no API costs)</p>
            {% else %}
            <ul class="glass-box-params">
                <li><strong>Input Tokens:</strong> {{ "{:,}".format(generation_metadata.token_usage.input_tokens) }}</li>
                <li><strong>Output Tokens:</strong> {{ "{:,}".format(generation_metadata.token_usage.output_tokens) }}</li>
                <li><strong>Total Tokens:</strong> {{ "{:,}".format(generation_metadata.token_usage.total_tokens) }}</li>
                <li><strong>Estimated Cost:</strong> ${{ "%.4f"|format(generation_metadata.token_usage.estimated_cost) }}</li>
            </ul>
            {% endif %}
            <p class="glass-box-note">Token counts {% if generation_metadata.token_usage.is_mock %}are zero in mock mode. Switch to a real provider to see actual costs.{% else %}are reported by the language model provider. Cost is estimated from published pricing.{% endif %}</p>
        </div>
        {% endif %}

        {# BL-041: Critic Feedback History #}
        {% if generation_metadata.critic_history %}
        <div class="glass-box-subsection">
            <h2>Quality Review History</h2>
            <p class="glass-box-note">The critic agent reviewed the generated questions for quality, accuracy, and alignment. Here is what happened:</p>
            {% for entry in generation_metadata.critic_history %}
            <div class="critic-entry critic-{{ entry.status|lower }}">
                <strong>Attempt {{ entry.attempt }}:</strong>
                <span class="status status-{% if entry.status == 'APPROVED' %}generated{% else %}failed{% endif %}">{{ entry.status }}</span>
                {% if entry.feedback %}
                <p class="critic-feedback">{{ entry.feedback[:500] }}{% if entry.feedback|length > 500 %}...{% endif %}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</details>
{% endif %}

{# Variant lineage #}
{% if parent_quiz %}
<div class="variant-lineage">
    <strong>Source Quiz:</strong> <a href="/quizzes/{{ parent_quiz.id }}">{{ parent_quiz.title }}</a>
</div>
{% endif %}
{% if variant_count and variant_count > 0 %}
<div class="variant-lineage">
    <strong>Variants:</strong> <a href="/quizzes/{{ quiz.id }}/variants">{{ variant_count }} variant{{ 's' if variant_count != 1 }}</a>
</div>
{% endif %}

<div class="export-actions">
    <button class="btn-print" onclick="window.print()">Print</button>

    <span class="export-label">Teacher Copy (with answers):</span>
    <a href="/quizzes/{{ quiz.id }}/export/docx" class="btn btn-sm btn-outline">Word</a>
    <a href="/quizzes/{{ quiz.id }}/export/pdf" class="btn btn-sm btn-outline">PDF</a>
    <a href="/quizzes/{{ quiz.id }}/export/csv" class="btn btn-sm btn-outline">CSV</a>

    <span class="export-label">Student Copy (no answers):</span>
    <a href="/quizzes/{{ quiz.id }}/export/docx?student=1" class="btn btn-sm btn-outline">Word</a>
    <a href="/quizzes/{{ quiz.id }}/export/pdf?student=1" class="btn btn-sm btn-outline">PDF</a>

    <span class="export-label">LMS Import:</span>
    <a href="/quizzes/{{ quiz.id }}/export/gift" class="btn btn-sm btn-outline">GIFT (Moodle)</a>
    <a href="/quizzes/{{ quiz.id }}/export/qti" class="btn btn-sm btn-outline">QTI (Canvas)</a>
    <a href="/quizzes/{{ quiz.id }}/export/quizizz" class="btn btn-sm btn-outline">Quizizz CSV</a>
    <a href="/quizzes/{{ quiz.id }}/export-template" class="btn btn-sm btn-outline">Export as Template</a>

    {% if tts_available %}
    <span class="export-label">Audio:</span>
    <button class="btn btn-sm btn-outline" id="generateAudioBtn" {% if quiz_has_audio %}style="display:none;"{% endif %}>Generate Audio</button>
    <span class="audio-status-badge" id="audioStatusBadge" {% if not quiz_has_audio %}style="display:none;"{% endif %}>Audio available</span>
    <a href="/quizzes/{{ quiz.id }}/audio/download" class="btn btn-sm btn-outline" id="downloadAudioBtn" {% if not quiz_has_audio %}style="display:none;"{% endif %}>Download Audio ZIP</a>
    {% endif %}
</div>

<div class="section-actions">
    <a href="/quizzes/{{ quiz.id }}/generate-variant" class="btn btn-sm btn-secondary">Generate Variant</a>
    <a href="/quizzes/{{ quiz.id }}/generate-rubric" class="btn btn-sm btn-secondary">Generate Rubric</a>
</div>

{# Rubrics for this quiz #}
{% if rubrics %}
<div class="rubric-list-section">
    <h2>Rubrics</h2>
    {% for r in rubrics %}
    <div class="rubric-card">
        <a href="/rubrics/{{ r.id }}">{{ r.title }}</a>
        <span class="status status-{{ r.status }}">{{ r.status }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- TTS Panel (BL-032) -->
<div class="tts-panel collapsed" id="ttsPanel">
    <div class="tts-panel-header">
        <h2>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
            Read Aloud
        </h2>
        <button class="tts-toggle-btn" aria-label="Toggle TTS panel" aria-expanded="false">+</button>
    </div>
    <div class="tts-controls">
        <button class="tts-btn" id="ttsPlayBtn" aria-label="Play speech">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            Play All
        </button>
        <button class="tts-btn" id="ttsStopBtn" aria-label="Stop speech">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><rect x="4" y="4" width="16" height="16"/></svg>
            Stop
        </button>
        <label for="ttsSpeedSlider">Speed:</label>
        <input type="range" id="ttsSpeedSlider" min="0.5" max="2" step="0.1" value="1.0" aria-label="Speech speed">
        <span class="tts-speed-value" id="ttsSpeedValue">1.0x</span>
        <label for="ttsVoiceSelect">Voice:</label>
        <select id="ttsVoiceSelect" aria-label="Select voice">
            <option value="">Default</option>
        </select>
    </div>
</div>

<h2>Questions <span class="help-tip" data-tip="{{ ai_tips.review_reminder }}">?</span></h2>
{% for q in questions %}
<div class="question-card" data-question-id="{{ q.id }}" data-quiz-id="{{ quiz.id }}">
    <div class="question-header">
        <span class="question-number">Q<span class="q-index">{{ loop.index }}</span></span>
        <span class="question-type">{{ q.type or 'unknown' }}</span>
        <span class="question-points">{{ q.points or 0 }} pts</span>
        {% if q.data and q.data.cognitive_level is defined and q.data.cognitive_level %}
        <span class="cognitive-badge cognitive-badge-{{ q.data.cognitive_level_number|default(0) }}">
            {{ q.data.cognitive_level }}
        </span>
        {% endif %}
        <button class="tts-read-btn" title="Read aloud" aria-label="Read this question aloud">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
        </button>
        {% if quiz_has_audio %}
        <a href="/quizzes/{{ quiz.id }}/audio/{{ q.id }}.mp3" class="btn btn-sm btn-outline audio-download-link" title="Download audio for this question" aria-label="Download audio" download>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            MP3
        </a>
        {% endif %}
        <span class="question-actions">
            <button class="btn btn-sm btn-outline btn-edit-question" title="Edit" aria-label="Edit question">Edit</button>
            <button class="btn btn-sm btn-outline btn-move-up" title="Move up" aria-label="Move question up">Up</button>
            <button class="btn btn-sm btn-outline btn-move-down" title="Move down" aria-label="Move question down">Down</button>
            <button class="btn btn-sm btn-outline btn-regen-question" title="Regenerate" aria-label="Regenerate question">Regen</button>
            <button class="btn btn-sm btn-outline btn-upload-image" title="Upload image" aria-label="Upload image">Image</button>
            <button class="btn btn-sm btn-outline btn-search-image" title="Search for images" aria-label="Search for images">Search</button>
            <button class="btn btn-sm {% if q.saved_to_bank %}btn-secondary{% else %}btn-outline{% endif %} btn-bank-toggle"
                    title="{% if q.saved_to_bank %}Remove from Bank{% else %}Save to Bank{% endif %}"
                    aria-label="{% if q.saved_to_bank %}Remove from question bank{% else %}Save to question bank{% endif %}"
                    data-saved="{{ 'true' if q.saved_to_bank else 'false' }}">
                {% if q.saved_to_bank %}Banked{% else %}Bank{% endif %}
            </button>
            <button class="btn btn-sm btn-danger btn-delete-question" title="Delete" aria-label="Delete question">Delete</button>
            <input type="file" class="image-file-input" accept=".png,.jpg,.jpeg,.gif,.webp" style="display:none;">
        </span>
    </div>

    {# --- View mode --- #}
    <div class="question-view-mode">
        <p class="question-text">{{ q.text }}</p>

        {% if q.data and q.data.image_ref is defined and q.data.image_ref %}
        <div class="question-image-wrapper">
            <img src="/uploads/images/{{ q.data.image_ref }}" alt="Question image" class="question-image"
                 onerror="this.src='/generated_images/{{ q.data.image_ref }}'; this.onerror=function(){this.style.display='none'}">
            <button class="btn btn-sm btn-outline btn-remove-image" aria-label="Remove question image">Remove Image</button>
        </div>
        {% elif q.data and q.data.image_description is defined and q.data.image_description %}
        <div class="image-placeholder"
             {% if q.data.image_search_terms is defined and q.data.image_search_terms %}data-search-terms="{{ q.data.image_search_terms|join(' ') }}"{% endif %}>
            <strong>Suggested image:</strong> <span class="image-desc-text">{{ q.data.image_description }}</span>
            {% if q.data.image_reveals_answer is defined and q.data.image_reveals_answer %}
            <span class="image-reveals-answer-warning" title="This suggested image may give away the answer to the question">May reveal answer</span>
            {% endif %}
            <button class="btn-clear-image-desc" title="Remove suggested image" aria-label="Remove suggested image description">&times;</button>
            <div class="image-search-links">
                <a href="#" class="image-search-link" data-provider="pixabay" target="_blank" rel="noopener" title="Search Pixabay for this image">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    Pixabay
                </a>
                <a href="#" class="image-search-link" data-provider="wikimedia" target="_blank" rel="noopener" title="Search Wikimedia Commons for this image">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    Wikimedia
                </a>
            </div>
        </div>
        {% elif q.data and q.data.image is defined and q.data.image %}
        <div class="question-image-external" data-src="{{ q.data.image }}">
            <img src="{{ q.data.image }}" alt="Question image" class="question-image" referrerpolicy="no-referrer"
                 onerror="this.parentElement.innerHTML='<span class=\'image-placeholder\'>Image unavailable. Consider uploading your own.</span>'">
        </div>
        {% endif %}

        {% if q.type == 'stimulus' or (q.data and q.data.type is defined and q.data.type == 'stimulus') %}
        {# --- Stimulus/Passage question display --- #}
        {% if q.data and q.data.stimulus_text is defined and q.data.stimulus_text %}
        <div class="stimulus-passage">
            <div class="stimulus-passage-label">Passage:</div>
            <blockquote class="stimulus-text">{{ q.data.stimulus_text }}</blockquote>
        </div>
        {% endif %}
        {% if q.data and q.data.image_url is defined and q.data.image_url %}
        <div class="stimulus-image">
            <img src="{{ q.data.image_url }}" alt="Stimulus image" class="question-image" referrerpolicy="no-referrer"
                 onerror="this.style.display='none'">
        </div>
        {% endif %}
        {% if q.data and q.data.sub_questions is defined and q.data.sub_questions %}
        <div class="stimulus-sub-questions">
            {% for sq in q.data.sub_questions %}
            <div class="sub-question" data-sub-index="{{ loop.index0 }}">
                <p class="sub-question-header">
                    <strong>Part {{ loop.index }}.</strong>
                    <span class="question-type">{{ sq.type or 'mc' }}</span>
                    <span class="question-points">{{ sq.points or 1 }} pts</span>
                </p>
                <p class="sub-question-text">{{ sq.text }}</p>
                {% if sq.type == 'mc' and sq.options is defined %}
                <ul class="question-options">
                    {% for opt in sq.options %}
                    <li{% if sq.correct_index is defined and loop.index0 == sq.correct_index %} class="correct"{% endif %}>{{ opt }}</li>
                    {% endfor %}
                </ul>
                {% elif sq.type == 'tf' %}
                <div class="tf-answer">
                    <span class="tf-option {% if sq.correct_answer == 'True' %}correct{% endif %}">True</span>
                    <span class="tf-option {% if sq.correct_answer == 'False' %}correct{% endif %}">False</span>
                </div>
                {% elif sq.type == 'short_answer' %}
                <div class="short-answer-blank"><p>________________________________________</p></div>
                <div class="question-answer">
                    <strong>Expected Answer:</strong> {{ sq.expected_answer or '' }}
                    {% if sq.acceptable_answers is defined and sq.acceptable_answers %}
                    <br><strong>Also accepted:</strong> {{ sq.acceptable_answers|join(', ') }}
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% elif q.type == 'cloze' or (q.data and q.data.type is defined and q.data.type == 'cloze') %}
        {# --- Cloze question display --- #}
        {% if q.data and q.data.blanks is defined and q.data.blanks %}
        <div class="cloze-question">
            <p class="cloze-text">
                {% set cloze_display = q.text|e %}
                {% for blank in q.data.blanks %}
                {% set safe_id = blank.id|e %}
                {% set placeholder = '{{' ~ safe_id ~ '}}' %}
                {% set underline = '<span class="cloze-blank" data-blank-id="' ~ safe_id ~ '">________<sub>(' ~ safe_id ~ ')</sub></span>' %}
                {% set cloze_display = cloze_display|replace(placeholder, underline) %}
                {% endfor %}
                {{ cloze_display|safe }}
            </p>
            <div class="cloze-answers">
                <strong>Answers:</strong>
                {% for blank in q.data.blanks %}
                <span class="cloze-answer-item">
                    ({{ blank.id }}) {{ blank.answer }}
                    {% if blank.alternatives is defined and blank.alternatives %}
                    <em class="cloze-alts">(also: {{ blank.alternatives|join(', ') }})</em>
                    {% endif %}
                </span>
                {% if not loop.last %} | {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% elif q.type == 'matching' or (q.data and q.data.question_type is defined and q.data.question_type == 'matching') %}
        {# --- Matching question display --- #}
        {% set matches = q.data.matches if q.data.matches is defined else [] %}
        {% if matches %}
        {# Interactive drag-and-drop (BL-038) — hidden until JS activates #}
        <div class="matching-interactive" data-matches='{{ matches|tojson }}'></div>
        {# Static fallback for no-JS environments #}
        <table class="matching-table matching-static-fallback">
            <thead>
                <tr><th>Term</th><th>Definition</th></tr>
            </thead>
            <tbody>
                {% for m in matches %}
                <tr>
                    <td>{{ m.term }}</td>
                    <td>{{ m.definition }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% elif q.data.prompt_items is defined and q.data.response_items is defined %}
        <div class="matching-columns">
            <div class="matching-col">
                <strong>Terms:</strong>
                <ol>{% for item in q.data.prompt_items %}<li>{{ item }}</li>{% endfor %}</ol>
            </div>
            <div class="matching-col">
                <strong>Definitions:</strong>
                <ol type="A">{% for item in q.data.response_items %}<li>{{ item }}</li>{% endfor %}</ol>
            </div>
        </div>
        {% endif %}

        {% elif q.data and q.data.question_type is defined and q.data.question_type == 'ordering' %}
        {# --- Ordering question display --- #}
        {% if q.data.instructions is defined and q.data.instructions %}
        <p class="ordering-instructions"><em>{{ q.data.instructions }}</em></p>
        {% endif %}
        {# Interactive drag-and-drop (BL-038) — hidden until JS activates #}
        {% if q.data['items'] is defined and q.data.correct_order is defined %}
        <div class="ordering-interactive" data-items='{{ q.data["items"]|tojson }}' data-correct-order='{{ q.data.correct_order|tojson }}'></div>
        {% endif %}
        {# Static fallback for no-JS environments #}
        <ol class="ordering-items ordering-static-fallback">
            {% for item in q.data['items'] %}
            <li>{{ item }}</li>
            {% endfor %}
        </ol>
        <div class="question-answer ordering-static-fallback">
            <strong>Correct Order:</strong>
            {% if q.data.correct_order is defined %}
            {% for idx in q.data.correct_order %}{% if idx < q.data['items']|length %}{% if not loop.first %} &rarr; {% endif %}{{ q.data['items'][idx] }}{% endif %}{% endfor %}
            {% endif %}
        </div>

        {% elif q.data and q.data.question_type is defined and q.data.question_type == 'short_answer' %}
        {# --- Short answer question display --- #}
        <div class="short-answer-blank">
            <p>________________________________________</p>
        </div>
        <div class="question-answer">
            <strong>Expected Answer:</strong> {{ q.data.expected_answer or '' }}
            {% if q.data.acceptable_answers is defined and q.data.acceptable_answers %}
            <br><strong>Also accepted:</strong> {{ q.data.acceptable_answers|join(', ') }}
            {% endif %}
            {% if q.data.rubric_hint is defined and q.data.rubric_hint %}
            <br><em>Rubric hint: {{ q.data.rubric_hint }}</em>
            {% endif %}
        </div>

        {% elif q.type == 'ma' or (q.data and q.data.type is defined and q.data.type == 'ma') or (q.data and q.data.question_type is defined and q.data.question_type == 'multiple_answer') %}
        {# --- Multiple Answer (select all that apply) --- #}
        <p class="ma-instruction"><em>Select ALL that apply.</em></p>
        {% if q.data and q.data.options is defined %}
        <ul class="question-options ma-options">
            {% set correct_indices = q.data.correct_indices if q.data.correct_indices is defined else [] %}
            {% for option in q.data.options %}
            <li{% if loop.index0 in correct_indices %} class="correct"{% endif %}>
                <span class="ma-checkbox">&#9744;</span> {{ option }}
            </li>
            {% endfor %}
        </ul>
        {% endif %}
        {% if q.data and q.data.correct_indices is defined and q.data.correct_indices and q.data.options is defined %}
        <div class="question-answer">
            <strong>Correct Answers:</strong>
            {% for idx in q.data.correct_indices %}{% if idx < q.data.options|length %}{% if not loop.first %}, {% endif %}{{ q.data.options[idx] }}{% endif %}{% endfor %}
        </div>
        {% endif %}

        {% elif q.type == 'tf' or q.question_type == 'tf' %}
        <div class="tf-answer">
            <span class="tf-option {% if q.data.correct_answer == 'True' or q.data.answer == 'True' %}correct{% endif %}">True</span>
            <span class="tf-option {% if q.data.correct_answer == 'False' or q.data.answer == 'False' %}correct{% endif %}">False</span>
        </div>
        {% elif q.data and q.data.options is defined %}
        <ul class="question-options">
            {% for option in q.data.options %}
            {% if option is mapping %}
            <li{% if q.data.correct_answers is defined and option.id in q.data.correct_answers %} class="correct"{% endif %}>
                <strong>{{ option.id }}.</strong> {{ option.text }}
            </li>
            {% else %}
            <li{% if q.data.correct_answer is defined and option == q.data.correct_answer %} class="correct"{% elif q.data.correct_index is defined and loop.index0 == q.data.correct_index %} class="correct"{% endif %}>
                {{ option }}
            </li>
            {% endif %}
            {% endfor %}
        </ul>
        {% endif %}

        {# Word bank for fill-in questions #}
        {% if q.data and q.data.word_bank is defined and q.data.word_bank %}
        <div class="word-bank">
            <strong>Word Bank:</strong> {{ q.data.word_bank|join(', ') }}
        </div>
        {% endif %}

        {% if q.data %}
        {% set answer = q.data.correct_answer or q.data.answer or none %}
        {% if answer and q.type != 'tf' and q.question_type != 'tf' and (q.data.question_type is not defined or q.data.question_type not in ['ordering', 'short_answer']) %}
        <div class="question-answer">
            <strong>Answer:</strong> {{ answer }}
        </div>
        {% endif %}
        {% endif %}
    </div>

    {# --- Edit mode (hidden by default) --- #}
    <div class="question-edit-mode" style="display:none;">
        <div class="form-group">
            <label>Question Text</label>
            <textarea class="edit-question-text" rows="3">{{ q.text }}</textarea>
        </div>
        <div class="edit-row">
            <div class="form-group form-group-inline">
                <label>Points</label>
                <input type="number" class="edit-question-points" value="{{ q.points or 1 }}" min="0" step="0.5">
            </div>
            <div class="form-group form-group-inline">
                <label>Type</label>
                <select class="edit-question-type">
                    <option value="mc" {% if q.type == 'mc' %}selected{% endif %}>Multiple Choice</option>
                    <option value="tf" {% if q.type == 'tf' %}selected{% endif %}>True/False</option>
                    <option value="ma" {% if q.type == 'ma' %}selected{% endif %}>Multiple Answer</option>
                    <option value="fill_in_blank" {% if q.type == 'fill_in_blank' %}selected{% endif %}>Fill in Blank</option>
                    <option value="short_answer" {% if q.type == 'short_answer' %}selected{% endif %}>Short Answer</option>
                    <option value="ordering" {% if q.type == 'ordering' %}selected{% endif %}>Ordering</option>
                    <option value="matching" {% if q.type == 'matching' %}selected{% endif %}>Matching</option>
                    <option value="essay" {% if q.type == 'essay' %}selected{% endif %}>Essay</option>
                    <option value="stimulus" {% if q.type == 'stimulus' %}selected{% endif %}>Stimulus / Passage</option>
                    <option value="cloze" {% if q.type == 'cloze' %}selected{% endif %}>Cloze (Fill Multiple Blanks)</option>
                </select>
            </div>
        </div>

        {# MC/MA options editor #}
        <div class="edit-options-section" {% if q.type not in ('mc', 'ma') and q.type != none %}style="display:none;"{% endif %}>
            <label>Options</label>
            <div class="edit-options-list">
                {% if q.data and q.data.options is defined %}
                {% for option in q.data.options %}
                <div class="edit-option-row">
                    <input type="radio" name="correct_{{ q.id }}" class="edit-correct-radio" value="{{ loop.index0 }}"
                           {% if q.data.correct_index is defined and loop.index0 == q.data.correct_index %}checked{% endif %}>
                    <input type="text" class="edit-option-text" value="{% if option is mapping %}{{ option.text }}{% else %}{{ option }}{% endif %}">
                    <button class="btn btn-sm btn-outline btn-remove-option" title="Remove option" aria-label="Remove option">x</button>
                </div>
                {% endfor %}
                {% endif %}
            </div>
            <button class="btn btn-sm btn-outline btn-add-option">+ Add Option</button>
        </div>

        {# TF correct answer #}
        <div class="edit-tf-section" {% if q.type != 'tf' %}style="display:none;"{% endif %}>
            <label>Correct Answer</label>
            <div class="radio-group">
                <label><input type="radio" name="tf_{{ q.id }}" class="edit-tf-radio" value="True"
                    {% if q.data and (q.data.correct_answer == 'True' or q.data.answer == 'True') %}checked{% endif %}> True</label>
                <label><input type="radio" name="tf_{{ q.id }}" class="edit-tf-radio" value="False"
                    {% if q.data and (q.data.correct_answer == 'False' or q.data.answer == 'False') %}checked{% endif %}> False</label>
            </div>
        </div>

        <div class="form-actions">
            <button class="btn btn-sm btn-primary btn-save-question">Save</button>
            <button class="btn btn-sm btn-secondary btn-cancel-edit">Cancel</button>
        </div>
    </div>

    {# --- Regenerate panel (hidden by default) --- #}
    <div class="question-regen-panel" style="display:none;">
        <div class="form-group">
            <label>Teacher Notes (optional guidance for the new question)</label>
            <textarea class="regen-notes" rows="2" placeholder="e.g., Make it about cellular respiration instead"></textarea>
        </div>
        <div class="form-actions">
            <button class="btn btn-sm btn-primary btn-regen-submit">Regenerate</button>
            <button class="btn btn-sm btn-secondary btn-regen-cancel">Cancel</button>
        </div>
    </div>
</div>
{% endfor %}

<p><a href="/quizzes">&larr; Back to Quizzes</a></p>

{# --- Image Search Modal --- #}
<div class="image-search-modal" id="imageSearchModal" style="display:none;" role="dialog" aria-label="Image search">
    <div class="image-search-modal-content">
        <div class="image-search-modal-header">
            <h3>Search Images</h3>
            <button class="image-search-modal-close" aria-label="Close image search">&times;</button>
        </div>
        <div class="image-search-modal-body">
            <div class="image-search-form">
                <input type="text" id="imageSearchQuery" class="image-search-input" placeholder="Search for images...">
                <select id="imageSearchType" class="image-search-type-select">
                    <option value="illustration">Illustrations</option>
                    <option value="photo">Photos</option>
                    <option value="vector">Vectors</option>
                    <option value="all">All</option>
                </select>
                <button class="btn btn-primary btn-image-search-go" id="imageSearchBtn">Search</button>
            </div>
            <div class="image-search-status" id="imageSearchStatus"></div>
            <div class="image-search-grid" id="imageSearchGrid"></div>
            <div class="image-search-attribution">
                Images provided by <a href="https://pixabay.com/" target="_blank" rel="noopener">Pixabay</a> (free for commercial use, no attribution required).
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/quiz_edit.js') }}"></script>
<script src="{{ url_for('static', filename='js/tts.js') }}"></script>
<script src="{{ url_for('static', filename='js/matching.js') }}"></script>
<script>
(function() {
    // --- Search link URL builder ---
    document.querySelectorAll('.image-search-link').forEach(function(link) {
        var placeholder = link.closest('.image-placeholder');
        if (!placeholder) return;
        // Prefer image_search_terms over full description for more effective searches
        var searchTerms = placeholder.dataset.searchTerms;
        if (!searchTerms) {
            var descEl = placeholder.querySelector('.image-desc-text');
            searchTerms = descEl ? descEl.textContent.trim() : '';
        }
        if (!searchTerms) return;
        var provider = link.dataset.provider;
        if (provider === 'pixabay') {
            link.href = 'https://pixabay.com/images/search/' + encodeURIComponent(searchTerms) + '/';
        } else if (provider === 'wikimedia') {
            link.href = 'https://commons.wikimedia.org/w/index.php?search=' + encodeURIComponent(searchTerms) + '&title=Special:MediaSearch&type=image';
        }
    });

    // --- Image Search Modal ---
    var modal = document.getElementById('imageSearchModal');
    var searchInput = document.getElementById('imageSearchQuery');
    var searchBtn = document.getElementById('imageSearchBtn');
    var searchGrid = document.getElementById('imageSearchGrid');
    var searchStatus = document.getElementById('imageSearchStatus');
    var searchType = document.getElementById('imageSearchType');
    var activeQuestionId = null;
    var csrfToken = (document.querySelector('meta[name="csrf-token"]') || {}).content || '';

    // Open modal from Search button on question card
    document.addEventListener('click', function(e) {
        var btn = e.target.closest('.btn-search-image');
        if (!btn) return;
        var card = btn.closest('.question-card');
        activeQuestionId = card.dataset.questionId;
        // Pre-fill: prefer image_search_terms over full description
        var placeholder = card.querySelector('.image-placeholder');
        var searchTerms = placeholder ? placeholder.dataset.searchTerms : '';
        if (!searchTerms) {
            var descEl = card.querySelector('.image-desc-text');
            searchTerms = descEl ? descEl.textContent.trim() : '';
        }
        searchInput.value = searchTerms;
        searchGrid.innerHTML = '';
        searchStatus.textContent = '';
        modal.style.display = 'flex';
        searchInput.focus();
    });

    // Close modal
    modal.querySelector('.image-search-modal-close').addEventListener('click', function() {
        modal.style.display = 'none';
        activeQuestionId = null;
    });
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            activeQuestionId = null;
        }
    });

    // Perform search
    function doSearch() {
        var query = searchInput.value.trim();
        if (!query) return;
        searchStatus.textContent = 'Searching...';
        searchGrid.innerHTML = '';
        fetch('/api/image-search?q=' + encodeURIComponent(query) + '&type=' + encodeURIComponent(searchType.value))
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data.ok) {
                    searchStatus.textContent = data.error || 'Search failed.';
                    return;
                }
                if (!data.hits || data.hits.length === 0) {
                    searchStatus.textContent = 'No images found. Try different keywords.';
                    return;
                }
                searchStatus.textContent = data.hits.length + ' images found. Click to use.';
                data.hits.forEach(function(hit) {
                    var thumb = document.createElement('div');
                    thumb.className = 'image-search-thumb';
                    thumb.innerHTML = '<img src="' + hit.thumbnail + '" alt="' + (hit.tags || '').replace(/"/g, '&quot;') + '" loading="lazy">'
                        + '<span class="image-search-thumb-tags">' + (hit.tags || '') + '</span>';
                    thumb.dataset.mediumUrl = hit.medium;
                    thumb.dataset.pageUrl = hit.page_url;
                    searchGrid.appendChild(thumb);
                });
            })
            .catch(function() {
                searchStatus.textContent = 'Search request failed. Check your connection.';
            });
    }

    searchBtn.addEventListener('click', doSearch);
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); doSearch(); }
    });

    // Select an image from results
    searchGrid.addEventListener('click', function(e) {
        var thumb = e.target.closest('.image-search-thumb');
        if (!thumb || !activeQuestionId) return;
        var url = thumb.dataset.mediumUrl;
        if (!url) return;
        searchStatus.textContent = 'Downloading image...';
        fetch('/api/questions/' + activeQuestionId + '/image-from-url', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({url: url})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) {
                // Refresh the question's image display
                var card = document.querySelector('.question-card[data-question-id="' + activeQuestionId + '"]');
                if (card) {
                    var viewMode = card.querySelector('.question-view-mode');
                    // Remove old placeholder / external image
                    var old = viewMode.querySelector('.image-placeholder, .question-image-external');
                    if (old) old.remove();
                    // Insert or update image wrapper
                    var wrapper = viewMode.querySelector('.question-image-wrapper');
                    if (!wrapper) {
                        wrapper = document.createElement('div');
                        wrapper.className = 'question-image-wrapper';
                        var questionText = viewMode.querySelector('.question-text');
                        if (questionText) questionText.after(wrapper);
                        else viewMode.prepend(wrapper);
                    }
                    wrapper.innerHTML = '<img src="' + data.url + '" alt="Question image" class="question-image">'
                        + '<button class="btn btn-sm btn-outline btn-remove-image" aria-label="Remove question image">Remove Image</button>';
                }
                modal.style.display = 'none';
                activeQuestionId = null;
            } else {
                searchStatus.textContent = data.error || 'Failed to attach image.';
            }
        })
        .catch(function() {
            searchStatus.textContent = 'Failed to attach image. Check your connection.';
        });
    });
})();

// --- Server-Side TTS: Generate Audio Button ---
(function() {
    var genBtn = document.getElementById('generateAudioBtn');
    if (!genBtn) return;
    var csrfToken = (document.querySelector('meta[name="csrf-token"]') || {}).content || '';
    var quizId = {{ quiz.id }};

    genBtn.addEventListener('click', function() {
        genBtn.disabled = true;
        genBtn.textContent = 'Generating...';
        fetch('/quizzes/' + quizId + '/generate-audio', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) {
                genBtn.style.display = 'none';
                var badge = document.getElementById('audioStatusBadge');
                if (badge) badge.style.display = '';
                var dlBtn = document.getElementById('downloadAudioBtn');
                if (dlBtn) dlBtn.style.display = '';
                // Reload to show per-question audio links
                window.location.reload();
            } else {
                genBtn.textContent = 'Generate Audio';
                genBtn.disabled = false;
                alert('Audio generation failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(function() {
            genBtn.textContent = 'Generate Audio';
            genBtn.disabled = false;
            alert('Audio generation request failed. Check your connection.');
        });
    });
})();
</script>
{% endblock %}
