{% extends "base.html" %}
{% block title %}{{ quiz.title }} - QuizWeaver{% endblock %}

{% block content %}
<h1>{{ quiz.title }}</h1>

<div class="quiz-info">
    <p><strong>Status:</strong> <span class="status status-{{ quiz.status }}">{{ quiz.status }}</span></p>
    {% if class_obj %}<p><strong>Class:</strong> <a href="/classes/{{ class_obj.id }}">{{ class_obj.name }}</a></p>{% endif %}
    <p><strong>Questions:</strong> {{ questions | length }}</p>
    {% if style_profile and style_profile.sol_standards is defined and style_profile.sol_standards %}
    <p><strong>Standards:</strong> {{ style_profile.sol_standards|join(', ') }}</p>
    {% endif %}
    {% if style_profile and style_profile.cognitive_framework is defined and style_profile.cognitive_framework %}
    <p><strong>Framework:</strong> {{ style_profile.cognitive_framework|capitalize }}</p>
    {% endif %}
    {% if style_profile and style_profile.difficulty is defined and style_profile.difficulty %}
    <p><strong>Difficulty:</strong> {{ style_profile.difficulty }}/5</p>
    {% endif %}
    {% if style_profile and style_profile.provider is defined and style_profile.provider %}
    <p><strong>Generated by:</strong> {{ style_profile.provider }}</p>
    {% endif %}
</div>

<h2>Questions</h2>
{% for q in questions %}
<div class="question-card">
    <div class="question-header">
        <span class="question-number">Q{{ loop.index }}</span>
        <span class="question-type">{{ q.type or 'unknown' }}</span>
        <span class="question-points">{{ q.points or 0 }} pts</span>
        {% if q.data and q.data.cognitive_level is defined and q.data.cognitive_level %}
        <span class="cognitive-badge cognitive-badge-{{ q.data.cognitive_level_number|default(0) }}">
            {{ q.data.cognitive_level }}
        </span>
        {% endif %}
    </div>
    <p class="question-text">{{ q.text }}</p>

    {% if q.data and q.data.image_ref is defined and q.data.image_ref %}
    <img src="/generated_images/{{ q.data.image_ref }}" alt="Question image" class="question-image"
         onerror="this.style.display='none'">
    {% elif q.data and q.data.image_description is defined and q.data.image_description %}
    <div class="image-placeholder">
        <strong>Suggested image:</strong> {{ q.data.image_description }}
    </div>
    {% elif q.data and q.data.image is defined and q.data.image %}
    <div class="question-image-external" data-src="{{ q.data.image }}">
        <img src="{{ q.data.image }}" alt="Question image" class="question-image" referrerpolicy="no-referrer"
             onerror="this.parentElement.innerHTML='<span class=\'image-placeholder\'>Image: AI suggested a diagram here but the URL is unavailable. Consider adding your own image.</span>'">
    </div>
    {% endif %}

    {% if q.type == 'tf' or q.question_type == 'tf' %}
    <div class="tf-answer">
        <span class="tf-option {% if q.data.correct_answer == 'True' or q.data.answer == 'True' %}correct{% endif %}">True</span>
        <span class="tf-option {% if q.data.correct_answer == 'False' or q.data.answer == 'False' %}correct{% endif %}">False</span>
    </div>
    {% elif q.data and q.data.options is defined %}
    <ul class="question-options">
        {% for option in q.data.options %}
        {% if option is mapping %}
        <li{% if q.data.correct_answers is defined and option.id in q.data.correct_answers %} class="correct"{% endif %}>
            <strong>{{ option.id }}.</strong> {{ option.text }}
        </li>
        {% else %}
        <li{% if q.data.correct_answer is defined and option == q.data.correct_answer %} class="correct"{% elif q.data.correct_index is defined and loop.index0 == q.data.correct_index %} class="correct"{% endif %}>
            {{ option }}
        </li>
        {% endif %}
        {% endfor %}
    </ul>
    {% endif %}

    {% if q.data %}
    {% set answer = q.data.correct_answer or q.data.answer or none %}
    {% if answer and q.type != 'tf' and q.question_type != 'tf' %}
    <div class="question-answer">
        <strong>Answer:</strong> {{ answer }}
    </div>
    {% endif %}
    {% endif %}
</div>
{% endfor %}

<p><a href="/quizzes">&larr; Back to Quizzes</a></p>
{% endblock %}
