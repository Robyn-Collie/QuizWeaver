{% extends "base.html" %}
{% block title %}Generate from Topics - QuizWeaver{% endblock %}

{% block content %}
<h1>Generate from Topics</h1>
<p class="text-muted">Create quizzes or study materials from topics -- no source quiz required.</p>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

<div class="ai-notice" data-dismiss-key="topic_gen_ai">
    <button class="ai-notice-dismiss" aria-label="Dismiss">&times;</button>
    <strong>AI-Generated Content:</strong> Output will be generated by AI and should be reviewed before use with students. You control which topics, standards, and settings are used.
</div>

<form method="POST" action="{{ url_for('generate_from_topics_page') }}" class="form">
    <div class="form-group">
        <label for="class_id">Class</label>
        <select id="class_id" name="class_id" class="form-control" required>
            {% for cls in classes %}
            <option value="{{ cls.id }}" {% if cls.id == selected_class_id %}selected{% endif %}>
                {{ cls.name }}{% if cls.grade_level %} ({{ cls.grade_level }}){% endif %}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="topics">Topics <span class="help-tip" data-tip="Enter topics to generate content about. Type to search your lesson history or add custom topics.">?</span></label>
        <input type="text" id="topics_search" class="form-control" placeholder="Type a topic and press Enter (e.g., photosynthesis, fractions)..." autocomplete="off">
        <input type="hidden" id="topics_val" name="topics" value="">
        <div class="standards-chips" id="topics_chips"></div>
        <div class="picker-hint" style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
            Type a topic and press Enter, or select from suggestions based on your lesson history.
        </div>
    </div>

    <div class="form-group">
        <label for="output_type">Output Type</label>
        <select id="output_type" name="output_type" class="form-control" required>
            <option value="quiz">Quiz</option>
            <option value="flashcard">Flashcards</option>
            <option value="study_guide">Study Guide</option>
            <option value="vocabulary">Vocabulary List</option>
            <option value="review_sheet">Review Sheet</option>
        </select>
    </div>

    <div id="quiz-options">
        <div class="form-group">
            <label for="num_questions">Number of Questions</label>
            <input type="number" id="num_questions" name="num_questions" value="20" min="1" max="50">
        </div>

        <div class="form-group">
            <label for="sol_standards_search">Standards (optional) <span class="help-tip" data-tip="Search for SOL standards to align generated content.">?</span></label>
            <div class="standards-picker">
                <input type="text" id="sol_standards_search" class="picker-input" placeholder="Type to search standards..." autocomplete="off">
                <input type="hidden" id="sol_standards_val" name="sol_standards" value="">
                <div class="picker-hint">Search the standards database or type a custom code and press Enter.</div>
            </div>
            <div class="standards-chips" id="sol_standards_chips"></div>
        </div>

        <div class="form-group">
            <label for="difficulty">Difficulty Level</label>
            <input type="range" id="difficulty" name="difficulty" min="1" max="5" value="3">
            <span id="difficulty-label">3 - Moderate</span>
        </div>
    </div>

    <div class="form-group">
        <label for="title">Title (optional)</label>
        <input type="text" id="title" name="title" placeholder="Auto-generated from topics if left blank">
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Generate</button>
        <a href="/dashboard" class="btn btn-secondary">Cancel</a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/standards_picker.css') }}">
<script src="{{ url_for('static', filename='js/standards_picker.js') }}"></script>
<script>
// Standards picker for SOL standards
initStandardsPicker({
    inputId: 'sol_standards_search',
    hiddenInputId: 'sol_standards_val',
    chipsContainerId: 'sol_standards_chips',
    apiUrl: '/api/standards/search',
    initialValues: []
});

// Topic input with autocomplete from lesson history
(function() {
    var input = document.getElementById('topics_search');
    var hidden = document.getElementById('topics_val');
    var chips = document.getElementById('topics_chips');
    var classSelect = document.getElementById('class_id');
    var selected = [];
    var debounceTimer = null;

    // Dropdown for topic suggestions
    var dropdown = document.createElement('div');
    dropdown.className = 'picker-dropdown';
    dropdown.style.position = 'absolute';
    input.parentNode.style.position = 'relative';
    input.parentNode.appendChild(dropdown);

    input.addEventListener('input', function() {
        var q = input.value.trim();
        clearTimeout(debounceTimer);
        if (q.length < 2) { dropdown.classList.remove('open'); dropdown.innerHTML = ''; return; }
        debounceTimer = setTimeout(function() {
            var classId = classSelect.value;
            fetch('/api/topics/search?class_id=' + classId + '&q=' + encodeURIComponent(q))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var results = (data.topics || []).filter(function(t) {
                        return selected.indexOf(t) === -1;
                    });
                    dropdown.innerHTML = '';
                    if (results.length === 0) {
                        dropdown.classList.remove('open');
                        return;
                    }
                    results.forEach(function(t) {
                        var opt = document.createElement('div');
                        opt.className = 'picker-option';
                        opt.textContent = t;
                        opt.addEventListener('click', function() {
                            addTopic(t);
                            input.value = '';
                            dropdown.classList.remove('open');
                            dropdown.innerHTML = '';
                            input.focus();
                        });
                        dropdown.appendChild(opt);
                    });
                    dropdown.classList.add('open');
                })
                .catch(function() { dropdown.classList.remove('open'); });
        }, 300);
    });

    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            var val = input.value.trim();
            if (val) {
                addTopic(val);
                input.value = '';
                dropdown.classList.remove('open');
                dropdown.innerHTML = '';
            }
        } else if (e.key === 'Backspace' && input.value === '' && selected.length > 0) {
            removeTopic(selected[selected.length - 1]);
        }
    });

    document.addEventListener('click', function(e) {
        if (!input.parentNode.contains(e.target)) {
            dropdown.classList.remove('open');
            dropdown.innerHTML = '';
        }
    });

    function addTopic(topic) {
        if (selected.indexOf(topic) !== -1) return;
        selected.push(topic);
        syncHidden();
        var chip = document.createElement('span');
        chip.className = 'standards-chip';
        chip.setAttribute('data-code', topic);
        chip.innerHTML = escapeHtml(topic) +
            '<button type="button" class="chip-remove" aria-label="Remove">&times;</button>';
        chip.querySelector('.chip-remove').addEventListener('click', function() {
            removeTopic(topic);
        });
        chips.appendChild(chip);
    }

    function removeTopic(topic) {
        selected = selected.filter(function(t) { return t !== topic; });
        syncHidden();
        var chip = chips.querySelector('[data-code="' + CSS.escape(topic) + '"]');
        if (chip) chip.remove();
    }

    function syncHidden() {
        hidden.value = selected.join(', ');
    }

    function escapeHtml(str) {
        var d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }
})();

// Show/hide quiz-specific options based on output type
(function() {
    var outputType = document.getElementById('output_type');
    var quizOptions = document.getElementById('quiz-options');
    function toggleOptions() {
        quizOptions.style.display = outputType.value === 'quiz' ? 'block' : 'none';
    }
    outputType.addEventListener('change', toggleOptions);
    toggleOptions();
})();

// Difficulty slider label
(function() {
    var slider = document.getElementById('difficulty');
    var label = document.getElementById('difficulty-label');
    var labels = {1: 'Easy', 2: 'Below Average', 3: 'Moderate', 4: 'Challenging', 5: 'Advanced'};
    function updateLabel() {
        label.textContent = slider.value + ' - ' + (labels[slider.value] || '');
    }
    if (slider && label) {
        slider.addEventListener('input', updateLabel);
        updateLabel();
    }
})();
</script>
{% endblock %}
